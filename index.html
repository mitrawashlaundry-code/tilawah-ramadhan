<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Tilawah Ramadhan</title>
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Tilawah">
<meta name="theme-color" content="#0a0e1a">
<link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Target%20Tilawah%20Ramadhan%22,%22short_name%22:%22Tilawah%22,%22start_url%22:%22./%22,%22display%22:%22standalone%22,%22background_color%22:%22%230a0e1a%22,%22theme_color%22:%22%230a0e1a%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,%253Csvg%2520xmlns%253D%2527http%253A%252F%252Fwww.w3.org%252F2000%252Fsvg%2527%2520viewBox%253D%25270%25200%2520512%2520512%2527%253E%253Crect%2520width%253D%2527512%2527%2520height%253D%2527512%2527%2520rx%253D%2527110%2527%2520fill%253D%2527%25230a0e1a%2527%252F%253E%253Ccircle%2520cx%253D%2527256%2527%2520cy%253D%2527220%2527%2520r%253D%2527120%2527%2520fill%253D%2527none%2527%2520stroke%253D%2527%2523e8b84b%2527%2520stroke-width%253D%252724%2527%252F%253E%253Ccircle%2520cx%253D%2527310%2527%2520cy%253D%2527200%2527%2520r%253D%2527115%2527%2520fill%253D%2527%25230a0e1a%2527%252F%253E%253Ctext%2520x%253D%2527256%2527%2520y%253D%2527420%2527%2520text-anchor%253D%2527middle%2527%2520font-size%253D%252772%2527%2520fill%253D%2527%2523e8b84b%2527%2520font-family%253D%2527serif%2527%253ETilawah%253C%252Ftext%253E%253C%252Fsvg%253E%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg+xml%22,%22purpose%22:%22any%20maskable%22}]}">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' rx='110' fill='%230a0e1a'/><circle cx='256' cy='220' r='120' fill='none' stroke='%23e8b84b' stroke-width='24'/><circle cx='310' cy='200' r='115' fill='%230a0e1a'/><text x='256' y='420' text-anchor='middle' font-size='72' fill='%23e8b84b' font-family='serif'>Tilawah</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DESIGN TOKENS v1.5
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
:root {
  --bg: #0a0e1a;
  --bg2: #0f1422;
  --surface: #141929;
  --surface2: #1a2035;
  --surface3: #202540;
  --border: #2a3150;
  --border2: #374060;

  --gold: #e8b84b;
  --gold2: #f5d06e;
  --gold-dim: rgba(232,184,75,0.12);
  --gold-glow: rgba(232,184,75,0.25);

  --amber: #f0a030;
  --amber-dim: rgba(240,160,48,0.15);

  --blue: #4a90e8;
  --blue-dim: rgba(74,144,232,0.13);

  --green: #3dd68c;
  --green-dim: rgba(61,214,140,0.13);

  --red: #e85454;
  --red-dim: rgba(232,84,84,0.13);

  --text: #e8eeff;
  --text2: #8899bb;
  --text3: #4a5578;

  --r: 16px;
  --r-sm: 10px;
  --shadow: 0 8px 40px rgba(0,0,0,0.5);

  --font-body: 'DM Sans', sans-serif;
  --font-display: 'Amiri', serif;

  /* v1.5: minimum font sizes enforced */
  --fs-base: 14px;        /* was ~11px */
  --fs-label: 12px;       /* was 9-10px */
  --fs-sm: 11px;          /* minimum */
  --fs-xs: 11px;          /* minimum (was 0.58rem~9px) */
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: var(--font-body);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
  font-size: var(--fs-base);
}

/* ‚îÄ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ‚îÄ */
::-webkit-scrollbar { width: 3px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

/* ‚îÄ‚îÄ‚îÄ UTILITY ‚îÄ‚îÄ‚îÄ */
.hidden { display: none !important; }
.flex { display: flex; }
.center { align-items: center; justify-content: center; }
.gap-s { gap: 8px; }
.gap-m { gap: 12px; }

/* ‚îÄ‚îÄ‚îÄ BACKGROUND EFFECTS ‚îÄ‚îÄ‚îÄ */
body::before {
  content: '';
  position: fixed;
  top: -200px; left: -200px;
  width: 600px; height: 600px;
  background: radial-gradient(ellipse, rgba(232,184,75,0.04) 0%, transparent 70%);
  pointer-events: none; z-index: 0;
}
body::after {
  content: '';
  position: fixed;
  bottom: -200px; right: -200px;
  width: 500px; height: 500px;
  background: radial-gradient(ellipse, rgba(74,144,232,0.05) 0%, transparent 70%);
  pointer-events: none; z-index: 0;
}

/* ‚îÄ‚îÄ‚îÄ ONBOARDING / WELCOME ‚îÄ‚îÄ‚îÄ */
#welcomeScreen {
  position: fixed; inset: 0;
  background: var(--bg);
  z-index: 1000;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 24px;
  animation: fadeIn 0.5s ease;
}
.welcome-logo {
  font-size: 72px;
  animation: float 3s ease-in-out infinite;
  margin-bottom: 16px;
  will-change: transform;
}
@media (prefers-reduced-motion: reduce) {
  .welcome-logo { animation: none; }
  .benefit-item { animation: none; opacity: 1; transform: none; }
  .btn-welcome { animation: none; opacity: 1; }
}
@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}
.welcome-title {
  font-family: var(--font-display);
  font-size: clamp(1.6rem, 5vw, 2.2rem);
  color: var(--gold2);
  text-align: center;
  line-height: 1.3;
  margin-bottom: 8px;
  text-shadow: 0 0 40px var(--gold-glow);
}
.welcome-sub {
  font-size: 0.9rem;
  color: var(--text2);
  text-align: center;
  margin-bottom: 36px;
  font-style: italic;
}
.benefits-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 10px;
  width: 100%;
  max-width: 380px;
  margin-bottom: 32px;
}
.benefit-item {
  display: flex; align-items: flex-start; gap: 14px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  padding: 14px;
  animation: slideUp 0.5s ease both;
}
.benefit-item:nth-child(1) { animation-delay: 0.1s; }
.benefit-item:nth-child(2) { animation-delay: 0.2s; }
.benefit-item:nth-child(3) { animation-delay: 0.3s; }
.benefit-icon { font-size: 1.6rem; flex-shrink: 0; }
.benefit-text strong { display: block; font-size: 0.88rem; color: var(--text); margin-bottom: 2px; }
.benefit-text span { font-size: 0.8rem; color: var(--text2); line-height: 1.5; }

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
.btn-welcome {
  background: linear-gradient(135deg, var(--gold), #c8902b);
  color: #0a0e1a;
  border: none;
  border-radius: 50px;
  padding: 16px 48px;
  font-size: 1rem;
  font-weight: 700;
  font-family: var(--font-body);
  cursor: pointer;
  box-shadow: 0 4px 20px var(--gold-glow);
  transition: all 0.2s ease;
  animation: slideUp 0.5s ease 0.5s both;
}
.btn-welcome:hover { transform: translateY(-2px); box-shadow: 0 8px 30px var(--gold-glow); }
.btn-welcome:active { transform: translateY(0); }

/* ‚îÄ‚îÄ‚îÄ SETUP WIZARD ‚îÄ‚îÄ‚îÄ */
#setupWizard {
  position: fixed; inset: 0;
  background: var(--bg);
  z-index: 999;
  display: flex; flex-direction: column;
  overflow-y: auto;
  padding-bottom: 100px;
}
.wizard-header {
  padding: 20px 20px 16px;
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  position: sticky; top: 0; z-index: 10;
}
.wizard-step-indicator {
  display: flex; gap: 6px; align-items: center;
  margin-bottom: 10px;
}
.step-dot {
  flex: 1; height: 3px; border-radius: 2px;
  background: var(--border2);
  transition: background 0.3s ease;
}
.step-dot.active { background: var(--gold); }
.step-dot.done { background: var(--green); }
.wizard-step-label {
  font-size: 0.75rem;
  color: var(--text2);
}
.wizard-step-label strong { color: var(--gold2); }
.wizard-body {
  padding: 20px;
  flex: 1;
}
.wizard-title {
  font-family: var(--font-display);
  font-size: 1.6rem;
  color: var(--gold2);
  margin-bottom: 6px;
}
.wizard-desc {
  font-size: 0.88rem;
  color: var(--text2);
  margin-bottom: 24px;
  line-height: 1.6;
}
.wizard-footer {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  padding: 16px 20px;
  background: linear-gradient(to top, var(--bg) 70%, transparent);
  display: flex; gap: 10px;
}

/* ‚îÄ‚îÄ‚îÄ KHATAM INFO BOX (v1.5 - new) ‚îÄ‚îÄ‚îÄ */
.khatam-info-box {
  background: var(--gold-dim);
  border: 1px solid rgba(232,184,75,0.25);
  border-radius: var(--r-sm);
  padding: 12px 14px;
  margin-bottom: 16px;
  font-size: 0.82rem;
  color: var(--text2);
  line-height: 1.6;
}
.khatam-info-box strong { color: var(--gold2); }

/* ‚îÄ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ‚îÄ */
#mainApp {
  display: none;
  min-height: 100vh;
  padding-bottom: 80px;
  position: relative; z-index: 1;
}

/* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
.app-header {
  background: linear-gradient(180deg, #0f1422 0%, #0a0e1a 100%);
  border-bottom: 1px solid var(--border);
  padding: 16px 16px 12px;
  position: sticky; top: 0; z-index: 100;
}
.header-top {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 10px;
}
.header-brand {
  display: flex; align-items: center; gap: 8px;
}
.header-brand .logo { font-size: 1.3rem; }
.header-brand h1 {
  font-family: var(--font-display);
  font-size: 1rem;
  color: var(--gold2);
  line-height: 1.2;
}
.header-brand .subtitle {
  font-size: 0.7rem;      /* v1.5: was 0.65rem */
  color: var(--text3);
}
.header-chips {
  display: flex; gap: 6px; flex-wrap: wrap;
  margin-bottom: 4px;
}
.chip {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 3px 10px;
  font-size: 0.72rem;     /* v1.5: was 0.68rem */
  color: var(--text2);
}
.chip.gold {
  background: var(--gold-dim);
  border-color: rgba(232,184,75,0.3);
  color: var(--gold2);
}
.header-today-summary {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  padding: 10px 12px;
  display: flex; align-items: center; justify-content: space-between;
  gap: 10px;
}
.today-progress-info {
  display: flex; flex-direction: column; gap: 3px; flex: 1;
}
.today-label {
  font-size: 0.69rem;     /* v1.5: was 0.65rem */
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 0.8px;
}
.today-value {
  font-size: 0.88rem;
  font-weight: 600;
  color: var(--text);
}
.today-mini-bar {
  width: 100%; height: 4px;
  background: var(--surface2);
  border-radius: 2px;
  overflow: hidden;
  margin-top: 3px;
}
.today-mini-fill {
  height: 100%;
  border-radius: 2px;
  transition: width 0.5s ease;
}
.today-pct {
  font-size: 1.4rem;
  font-weight: 700;
  line-height: 1;
  flex-shrink: 0;
}
.header-btn {
  background: none;
  border: 1px solid var(--border);
  border-radius: 50%;
  width: 36px; height: 36px;
  display: flex; align-items: center; justify-content: center;
  color: var(--text2);
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.2s;
}
.header-btn:hover { border-color: var(--gold); color: var(--gold2); }

/* ‚îÄ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ‚îÄ */
.bottom-nav {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--bg2);
  border-top: 1px solid var(--border);
  padding: 8px 4px 12px;
  display: flex;
  z-index: 100;
}
.nav-item {
  flex: 1;
  display: flex; flex-direction: column;
  align-items: center; gap: 2px;
  background: none; border: none;
  cursor: pointer;
  padding: 6px 4px;
  border-radius: var(--r-sm);
  transition: all 0.2s;
  color: var(--text3);
  font-family: var(--font-body);
  position: relative;
}
.nav-item.active { color: var(--gold2); }
.nav-item .nav-icon { font-size: 1.1rem; }
.nav-item .nav-label {
  font-size: 0.69rem;   /* v1.5: was 0.58rem (9px). Now 11px minimum. */
  font-weight: 500;
}
.nav-item.active::after {
  content: '';
  position: absolute; top: 0; left: 20%; right: 20%;
  height: 2px; border-radius: 0 0 2px 2px;
  background: var(--gold);
}
/* v1.5: Locked tabs - more visible indicator */
.nav-item.locked {
  opacity: 0.5;
  cursor: default;
}
.nav-item.locked .nav-label {
  font-size: 0.6rem;
  color: var(--text3);
}

/* ‚îÄ‚îÄ‚îÄ FAB ‚îÄ‚îÄ‚îÄ */
.fab {
  position: fixed;
  bottom: 80px; right: 16px;
  width: 48px; height: 48px;  /* v1.5: slightly larger */
  border-radius: 50%;
  background: linear-gradient(135deg, var(--gold), #c8902b);
  color: #0a0e1a;
  border: none;
  font-size: 1.2rem;
  cursor: pointer;
  box-shadow: 0 3px 14px var(--gold-glow), 0 2px 6px rgba(0,0,0,0.3);
  display: flex; align-items: center; justify-content: center;
  transition: all 0.3s;
  z-index: 99;
  opacity: 0.65;
}
.fab:hover, .fab:focus { transform: scale(1.08); box-shadow: 0 6px 24px var(--gold-glow); opacity: 1; }
.fab:active { transform: scale(0.95); opacity: 1; }
.fab.active-flash { opacity: 1; }

/* ‚îÄ‚îÄ‚îÄ SECTIONS ‚îÄ‚îÄ‚îÄ */
.section { display: none; padding: 14px 14px 0; animation: fadeIn 0.22s ease; }
.section.active { display: block; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; } }

/* ‚îÄ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ‚îÄ */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 16px;
  margin-bottom: 12px;
  transition: border-color 0.2s;
}
.card:hover { border-color: var(--border2); }
.card-header {
  display: flex; align-items: center; gap: 8px;
  margin-bottom: 14px;
}
.card-icon { font-size: 1rem; }
.card-title {
  font-size: 0.75rem;     /* v1.5: was 0.72rem */
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--gold);
  flex: 1;
}
.card-badge {
  font-size: 0.69rem;     /* v1.5: improved */
  background: var(--gold-dim);
  border: 1px solid rgba(232,184,75,0.3);
  color: var(--gold2);
  padding: 2px 8px;
  border-radius: 12px;
}

/* ‚îÄ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ‚îÄ */
label {
  display: block;
  font-size: 0.8rem;      /* v1.5: was 0.76rem */
  color: var(--text2);
  margin-bottom: 5px;
  font-weight: 500;
}
input[type="text"], input[type="number"], input[type="date"], select, textarea {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  padding: 11px 12px;
  color: var(--text);
  font-size: 0.9rem;
  font-family: var(--font-body);
  outline: none;
  transition: border-color 0.2s;
  -webkit-appearance: none;
}
input:focus, select:focus { border-color: var(--gold); }
.form-group { margin-bottom: 14px; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

/* ‚îÄ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ */
.btn {
  display: block; width: 100%;
  padding: 13px 16px;
  border-radius: var(--r-sm);
  font-size: 0.9rem;
  font-weight: 600;
  font-family: var(--font-body);
  cursor: pointer;
  border: none;
  text-align: center;
  transition: all 0.2s;
  margin-bottom: 8px;
}
.btn-primary { background: linear-gradient(135deg, var(--gold), #c8902b); color: #0a0e1a; }
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 16px var(--gold-glow); }
.btn-secondary { background: var(--surface2); border: 1px solid var(--border2); color: var(--text2); }
.btn-secondary:hover { border-color: var(--gold); color: var(--gold2); }
.btn-blue { background: var(--blue-dim); border: 1px solid rgba(74,144,232,0.4); color: var(--blue); }
.btn-blue:hover { background: rgba(74,144,232,0.25); }
.btn-amber { background: var(--amber-dim); border: 1px solid rgba(240,160,48,0.4); color: var(--amber); }
.btn-danger { background: var(--red-dim); border: 1px solid rgba(232,84,84,0.4); color: var(--red); }
.btn-ghost { background: none; border: 1px solid var(--border); color: var(--text2); }
.btn-ghost:hover { border-color: var(--gold); color: var(--gold2); }
.btn-sm { padding: 9px 14px; font-size: 0.82rem; }
.btn-auto { width: auto; display: inline-block; }

/* ‚îÄ‚îÄ‚îÄ QUICK BUTTONS ‚îÄ‚îÄ‚îÄ */
.quick-btns { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 14px; }
.quick-btn {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  padding: 10px 6px;
  cursor: pointer;
  font-size: 0.84rem;   /* v1.5: improved */
  font-weight: 700;
  color: var(--gold2);
  font-family: var(--font-body);
  transition: all 0.15s;
  text-align: center;
}
.quick-btn:hover { border-color: var(--gold); background: var(--gold-dim); }
.quick-btn:active { transform: scale(0.95); background: var(--gold); color: #0a0e1a; }

/* ‚îÄ‚îÄ‚îÄ KHATAM COUNTER ‚îÄ‚îÄ‚îÄ */
.khatam-row {
  display: flex; align-items: center; justify-content: center; gap: 20px;
  padding: 8px 0;
}
.khatam-btn {
  width: 44px; height: 44px;
  border-radius: 50%;
  background: var(--surface2);
  border: 1px solid var(--border);
  color: var(--text2);
  font-size: 1.2rem;
  cursor: pointer;
  transition: all 0.2s;
  display: flex; align-items: center; justify-content: center;
}
.khatam-btn:hover { border-color: var(--gold); color: var(--gold2); }
.khatam-num-big {
  font-family: var(--font-display);
  font-size: 2.8rem;
  font-weight: 700;
  color: var(--gold2);
  text-shadow: 0 0 30px var(--gold-glow);
  line-height: 1;
  min-width: 60px;
  text-align: center;
}

/* ‚îÄ‚îÄ‚îÄ PROGRESS RING ‚îÄ‚îÄ‚îÄ */
.progress-ring-wrap {
  display: flex; align-items: center; justify-content: center;
  margin: 10px 0;
  position: relative;
}
.ring-label {
  position: absolute;
  text-align: center;
  pointer-events: none;
}
.ring-pct { font-size: 1.8rem; font-weight: 700; color: var(--gold2); line-height: 1; }
.ring-sub { font-size: 0.69rem; color: var(--text2); margin-top: 2px; } /* v1.5: was 0.65rem */

/* ‚îÄ‚îÄ‚îÄ STAT GRID ‚îÄ‚îÄ‚îÄ */
.stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.stat-card {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  padding: 12px;
  text-align: center;
}
.stat-val { font-size: 1.3rem; font-weight: 700; color: var(--gold2); line-height: 1; }
.stat-lbl { font-size: 0.69rem; color: var(--text2); margin-top: 4px; line-height: 1.4; } /* v1.5: was 0.64rem */

/* ‚îÄ‚îÄ‚îÄ STATUS BANNER ‚îÄ‚îÄ‚îÄ */
.status-banner {
  border-radius: var(--r);
  padding: 14px 16px;
  margin-bottom: 12px;
}
.status-banner.ahead { background: var(--green-dim); border: 1px solid rgba(61,214,140,0.3); }
.status-banner.on-track { background: var(--blue-dim); border: 1px solid rgba(74,144,232,0.3); }
.status-banner.behind { background: var(--amber-dim); border: 1px solid rgba(240,160,48,0.3); }
.status-banner .status-icon { font-size: 1.5rem; margin-bottom: 6px; }
.status-banner .status-title { font-weight: 700; font-size: 0.92rem; margin-bottom: 4px; }
.status-banner.ahead .status-title { color: var(--green); }
.status-banner.on-track .status-title { color: var(--blue); }
.status-banner.behind .status-title { color: var(--amber); }
.status-banner .status-msg { font-size: 0.82rem; color: var(--text2); line-height: 1.55; } /* v1.5: was 0.8rem */
.status-banner .status-action { margin-top: 10px; }

/* ‚îÄ‚îÄ‚îÄ PROGRESSIVE DISCLOSURE (v1.5 new) ‚îÄ‚îÄ‚îÄ */
.collapsible-section {
  overflow: hidden;
  transition: max-height 0.4s ease;
  max-height: 0;
}
.collapsible-section.expanded {
  max-height: 9999px;
}
.collapse-toggle {
  display: flex; align-items: center; justify-content: center;
  gap: 6px;
  width: 100%;
  background: none;
  border: 1px dashed var(--border2);
  border-radius: var(--r-sm);
  padding: 10px;
  color: var(--text3);
  font-family: var(--font-body);
  font-size: 0.78rem;
  cursor: pointer;
  margin-bottom: 12px;
  transition: all 0.2s;
}
.collapse-toggle:hover { border-color: var(--gold); color: var(--gold2); }
.collapse-toggle .toggle-arrow { transition: transform 0.3s; display: inline-block; }
.collapse-toggle.open .toggle-arrow { transform: rotate(180deg); }

/* ‚îÄ‚îÄ‚îÄ STREAK DOTS (v1.5: larger) ‚îÄ‚îÄ‚îÄ */
.streak-bar { display: flex; gap: 3px; flex-wrap: wrap; justify-content: center; margin: 8px 0; }
.s-dot {
  width: 24px; height: 24px;  /* v1.5: was 16px */
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.55rem;
  font-weight: 700;
  position: relative;
}
.s-dot.over { background: var(--green-dim); border: 1.5px solid var(--green); }
.s-dot.on { background: var(--blue-dim); border: 1.5px solid var(--blue); }
.s-dot.today { background: var(--gold); border: 2px solid var(--gold2); color: #0a0e1a; }
.s-dot.miss { background: var(--amber-dim); border: 1.5px solid rgba(240,160,48,0.35); }
.s-dot.empty { background: var(--surface); border: 1.5px dashed var(--border); }
/* v1.5: day number displayed below dot via data attr */
.streak-day-label { font-size: 0.5rem; color: var(--text3); text-align: center; }
.streak-dot-wrap {
  display: flex; flex-direction: column; align-items: center; gap: 2px;
}

/* Streak legend */
.streak-legend {
  display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;
  margin-top: 8px; font-size: 0.69rem; color: var(--text3);  /* v1.5: was 0.6rem */
}
.streak-legend span { display: flex; align-items: center; gap: 4px; }
.sl-dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

/* ‚îÄ‚îÄ‚îÄ PRAYER GRID ‚îÄ‚îÄ‚îÄ */
.prayer-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 7px; }
@media (max-width: 340px) { .prayer-grid { grid-template-columns: repeat(2, 1fr); } }
.prayer-item {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  padding: 9px 6px;
  text-align: center;
  cursor: default;
}
.prayer-emoji { font-size: 1.1rem; display: block; }
.prayer-name { font-size: 0.69rem; color: var(--text2); margin: 3px 0 2px; }  /* v1.5: was 0.62rem */
.prayer-pages { font-size: 0.9rem; font-weight: 700; color: var(--gold2); }
.prayer-pages span { font-size: 0.69rem; color: var(--text3); font-weight: 400; } /* v1.5: was 0.62rem */

/* ‚îÄ‚îÄ‚îÄ LOG ENTRY ‚îÄ‚îÄ‚îÄ */
.log-entry {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 10px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  margin-bottom: 6px;
  font-size: 0.82rem;
}
.log-icon { font-size: 1.1rem; flex-shrink: 0; }
.log-main { flex: 1; min-width: 0; }
.log-prayer { font-weight: 600; color: var(--text); }
.log-pos { font-size: 0.75rem; color: var(--text3); margin-top: 1px; }  /* v1.5: was 0.69rem */
.log-right { display: flex; align-items: center; gap: 6px; }
.log-pages { color: var(--blue); font-weight: 700; font-size: 0.84rem; }
.log-time { font-size: 0.69rem; color: var(--text3); }
.log-del {
  background: none; border: none; color: var(--text3);
  cursor: pointer; padding: 4px 6px; border-radius: 6px;
  font-size: 0.9rem; transition: all 0.15s;
}
.log-del:hover { color: var(--red); background: var(--red-dim); }

/* ‚îÄ‚îÄ‚îÄ PROGRESS BAR ‚îÄ‚îÄ‚îÄ */
.prog-bar-wrap {
  background: var(--surface2);
  border-radius: 20px; height: 7px;
  overflow: hidden; margin: 6px 0;
}
.prog-bar-fill {
  height: 100%; border-radius: 20px;
  transition: width 0.6s cubic-bezier(.4,0,.2,1);
}
.prog-bar-fill.ahead { background: linear-gradient(90deg, var(--green), #4ade80); }
.prog-bar-fill.on-track { background: linear-gradient(90deg, var(--blue), #60a5fa); }
.prog-bar-fill.behind { background: linear-gradient(90deg, var(--amber), #fbbf24); }

/* ‚îÄ‚îÄ‚îÄ INSIGHT CARD ‚îÄ‚îÄ‚îÄ */
.insight-row {
  display: flex; align-items: center; gap: 10px;
  padding: 10px;
  background: var(--surface2);
  border-radius: var(--r-sm);
  margin-bottom: 7px;
}
.insight-icon { font-size: 1.1rem; flex-shrink: 0; }
.insight-text { font-size: 0.82rem; color: var(--text2); line-height: 1.5; flex: 1; }
.insight-text strong { color: var(--text); }

/* ‚îÄ‚îÄ‚îÄ CHART ‚îÄ‚îÄ‚îÄ */
.chart-wrap { overflow-x: auto; margin-top: 6px; }
.chart-bars {
  display: flex; align-items: flex-end; gap: 3px;
  height: 120px; padding: 0 2px;
  min-width: 100%;
}
.bar-col { display: flex; flex-direction: column; align-items: center; flex: 1; min-width: 16px; cursor: pointer; }
.bar-fill {
  width: 100%; border-radius: 4px 4px 0 0;
  min-height: 3px;
  transition: height 0.5s cubic-bezier(.4,0,.2,1);
}
.bar-fill.ahead { background: linear-gradient(180deg, var(--green), #15803d); }
.bar-fill.on-track { background: linear-gradient(180deg, var(--blue), #1d4ed8); }
.bar-fill.behind { background: linear-gradient(180deg, var(--amber), #92400e); }
.bar-lbl { font-size: 0.5rem; color: var(--text3); margin-top: 2px; text-align: center; }

/* ‚îÄ‚îÄ‚îÄ WEEKLY CARD ‚îÄ‚îÄ‚îÄ */
.week-card {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  padding: 12px;
  margin-bottom: 8px;
}
.week-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
.week-label { font-size: 0.75rem; font-weight: 700; color: var(--gold); }  /* v1.5: was 0.72rem */
.week-total { font-size: 0.75rem; color: var(--text2); }

/* ‚îÄ‚îÄ‚îÄ TREND CHART ‚îÄ‚îÄ‚îÄ */
.trend-wrap { position: relative; padding-bottom: 4px; }
.trend-cols {
  display: flex; align-items: flex-end; gap: 8px;
  height: 100px; padding: 0 4px;
}
.trend-col { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 3px; min-width: 0; }
.trend-bar {
  width: 100%; border-radius: 5px 5px 0 0; min-height: 4px;
  transition: height 0.5s cubic-bezier(.4,0,.2,1);
}
.trend-bar.up   { background: linear-gradient(180deg, var(--green), #15803d); }
.trend-bar.down { background: linear-gradient(180deg, var(--red), #991b1b); }
.trend-bar.flat { background: linear-gradient(180deg, var(--blue), #1d4ed8); }
.trend-bar.empty{ background: var(--surface3); opacity: 0.35; }
.trend-lbl-bottom { font-size: 0.62rem; color: var(--text3); margin-top: 2px; } /* v1.5: was 0.56rem */
.trend-lbl-top { font-size: 0.65rem; color: var(--text2); font-weight: 600; margin-bottom: 2px; } /* v1.5: was 0.6rem */
.trend-target-line {
  position: absolute; left: 4px; right: 4px;
  height: 1px; background: rgba(232,184,75,0.45);
  pointer-events: none;
}
.trend-legend {
  font-size: 0.69rem; color: var(--text3); text-align: center;
  margin-top: 8px; display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;
}
.trend-legend span { display: flex; align-items: center; gap: 4px; }
.tl-dot { display: inline-block; width: 8px; height: 8px; border-radius: 2px; }

/* ‚îÄ‚îÄ‚îÄ CARD ACTION BUTTON ‚îÄ‚îÄ‚îÄ */
.card-action-btn {
  margin-left: auto; flex-shrink: 0;
  background: none; border: 1px solid var(--border2);
  border-radius: 20px; padding: 3px 11px;
  font-size: 0.72rem; color: var(--text2);
  cursor: pointer; transition: all 0.15s; font-family: var(--font-body);
}
.card-action-btn:hover { color: var(--gold2); border-color: var(--gold); background: var(--gold-dim); }

/* ‚îÄ‚îÄ‚îÄ BREAKDOWN MANUAL EDIT ‚îÄ‚îÄ‚îÄ */
.bk-grid {
  display: grid; grid-template-columns: repeat(2,1fr); gap: 8px;
  margin-bottom: 12px;
}
.bk-item {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: var(--r-sm); padding: 10px 12px;
  display: flex; align-items: center; gap: 8px;
}
.bk-emoji { font-size: 1.2rem; flex-shrink: 0; }
.bk-name  { font-size: 0.75rem; color: var(--text2); flex: 1; min-width: 0; }  /* v1.5: was 0.72rem */
.bk-item input[type=number] {
  width: 52px; text-align: center; font-size: 0.9rem; font-weight: 700;
  color: var(--gold2); background: var(--surface3);
  border: 1px solid var(--border2); border-radius: 6px; padding: 4px 2px;
  -moz-appearance: textfield;
}
.bk-item input[type=number]::-webkit-inner-spin-button,
.bk-item input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; }
.bk-total-row {
  background: var(--gold-dim); border: 1px solid rgba(232,184,75,0.25);
  border-radius: var(--r-sm); padding: 8px 12px;
  display: flex; justify-content: space-between; align-items: center;
  font-size: 0.82rem; margin-bottom: 8px;
}
.bk-total-lbl { color: var(--text2); }
.bk-total-num { font-weight: 700; color: var(--gold2); }
.bk-total-num.warn { color: var(--amber); }
.bk-total-num.ok   { color: var(--green); }
.bk-note { font-size: 0.69rem; color: var(--text3); text-align: center; margin-top: 4px; }

/* ‚îÄ‚îÄ‚îÄ AUTOCOMPLETE DROPDOWN ‚îÄ‚îÄ‚îÄ */
.autocomplete-wrap { position: relative; }
.autocomplete-dropdown {
  position: absolute; z-index: 200;
  left: 0; right: 0; top: 100%;
  background: var(--surface2); border: 1px solid var(--border2);
  border-radius: 0 0 var(--r-sm) var(--r-sm);
  max-height: 180px; overflow-y: auto;
  box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  display: none;
}
.autocomplete-dropdown.open { display: block; }
.ac-item {
  padding: 10px 12px; font-size: 0.82rem; color: var(--text);  /* v1.5: was 0.78rem */
  cursor: pointer; border-bottom: 1px solid var(--border);
  transition: background 0.1s;
}
.ac-item:last-child { border-bottom: none; }
.ac-item:hover, .ac-item.focused { background: var(--gold-dim); color: var(--gold2); }
.ac-item .ac-surah { font-weight: 600; }
.ac-item .ac-juz  { font-size: 0.69rem; color: var(--text3); margin-left: 6px; }

/* ‚îÄ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ‚îÄ */
.badge-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
.badge-item {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  padding: 12px 8px;
  text-align: center;
  transition: all 0.2s;
  cursor: pointer;  /* v1.5: clickable for tooltip */
}
.badge-item.earned { border-color: rgba(232,184,75,0.4); background: var(--gold-dim); }
.badge-item.locked-badge { opacity: 0.4; filter: grayscale(1); }
.badge-emoji { font-size: 1.8rem; display: block; margin-bottom: 4px; }
.badge-name { font-size: 0.66rem; color: var(--text2); font-weight: 600; }  /* v1.5: was 0.62rem */
.badge-desc { font-size: 0.62rem; color: var(--text3); margin-top: 2px; }   /* v1.5: was 0.58rem */

/* ‚îÄ‚îÄ‚îÄ YEAR HISTORY ‚îÄ‚îÄ‚îÄ */
.year-card {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  padding: 14px;
  margin-bottom: 8px;
  display: flex; align-items: center; gap: 14px;
}
.year-icon { font-size: 2rem; flex-shrink: 0; }
.year-info { flex: 1; }
.year-label { font-size: 0.82rem; font-weight: 700; color: var(--gold2); }
.year-data { font-size: 0.75rem; color: var(--text2); margin-top: 2px; }  /* v1.5: was 0.72rem */

/* ‚îÄ‚îÄ‚îÄ SHARE CARD ‚îÄ‚îÄ‚îÄ */
#shareCanvas {
  border-radius: var(--r);
  max-width: 100%;
  display: block;
  margin: 0 auto;
}

/* ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ */
.modal-backdrop {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.75);
  z-index: 500;
  display: flex; align-items: flex-end; justify-content: center;
  padding: 0;
}
.modal-backdrop.center-modal { align-items: center; padding: 20px; }
.modal {
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: var(--r) var(--r) 0 0;
  padding: 20px;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 -8px 40px rgba(0,0,0,0.5);
  animation: slideModal 0.3s cubic-bezier(.4,0,.2,1);
}
.modal-backdrop.center-modal .modal {
  border-radius: var(--r);
  max-width: 420px;
  animation: fadeIn 0.2s ease;
}
@keyframes slideModal { from { transform: translateY(100%); } to { transform: translateY(0); } }
.modal-handle {
  width: 36px; height: 4px;
  background: var(--border2);
  border-radius: 2px;
  margin: 0 auto 16px;
}
.modal-title { font-size: 1rem; font-weight: 700; color: var(--gold2); margin-bottom: 8px; }
.modal-body { font-size: 0.84rem; color: var(--text2); margin-bottom: 16px; line-height: 1.65; }
.modal-actions { display: flex; gap: 8px; flex-wrap: wrap; }
.modal-actions .btn { flex: 1; margin: 0; }

/* ‚îÄ‚îÄ‚îÄ SHARE ACTION SHEET ‚îÄ‚îÄ‚îÄ */
#shareSheet {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.75);
  z-index: 600;
  display: flex; align-items: flex-end; justify-content: center;
}
.share-sheet-inner {
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: var(--r) var(--r) 0 0;
  width: 100%; max-width: 480px;
  padding: 20px 20px 32px;
  animation: slideModal 0.3s cubic-bezier(.4,0,.2,1);
}
.share-sheet-title {
  font-size: 0.78rem; color: var(--text3);
  text-align: center; margin-bottom: 16px;
  text-transform: uppercase; letter-spacing: 0.08em;
}
.share-options {
  display: grid; grid-template-columns: repeat(4, 1fr);
  gap: 12px; margin-bottom: 16px;
}
.share-option {
  display: flex; flex-direction: column; align-items: center; gap: 6px;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: var(--r-sm); padding: 14px 8px;
  cursor: pointer; transition: background 0.15s, border-color 0.15s;
}
.share-option:active { background: var(--surface3); border-color: var(--border2); }
.share-option-icon { font-size: 1.6rem; }
.share-option-label { font-size: 0.66rem; color: var(--text2); text-align: center; line-height: 1.3; }
.share-cancel {
  width: 100%; padding: 14px; background: var(--surface2);
  border: 1px solid var(--border); border-radius: var(--r-sm);
  color: var(--text2); font-size: 0.88rem; cursor: pointer;
  font-family: var(--font-body);
}

/* ‚îÄ‚îÄ‚îÄ BACKFILL BANNER ‚îÄ‚îÄ‚îÄ */
.backfill-banner {
  background: linear-gradient(135deg, rgba(74,144,232,0.15), rgba(74,144,232,0.08));
  border: 1px solid rgba(74,144,232,0.35);
  border-radius: var(--r);
  padding: 14px 16px;
  margin-bottom: 14px;
  display: flex; gap: 12px; align-items: flex-start;
}
.backfill-icon { font-size: 1.4rem; flex-shrink: 0; margin-top: 2px; }
.backfill-content { flex: 1; }
.backfill-title { font-size: 0.86rem; font-weight: 700; color: var(--blue); margin-bottom: 4px; }
.backfill-text { font-size: 0.8rem; color: var(--text2); line-height: 1.5; }
.backfill-btn {
  margin-top: 10px; padding: 8px 14px;
  background: rgba(74,144,232,0.2); border: 1px solid rgba(74,144,232,0.5);
  border-radius: 8px; color: var(--blue); font-size: 0.78rem;
  cursor: pointer; font-weight: 600; font-family: var(--font-body);
}

/* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
#toast {
  position: fixed; bottom: 90px; left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--surface3);
  border: 1px solid var(--border2);
  border-radius: 24px; padding: 10px 20px;
  font-size: 0.84rem; color: var(--text);
  z-index: 1000;
  transition: all 0.3s cubic-bezier(.4,0,.2,1);
  white-space: nowrap;
  box-shadow: var(--shadow);
  pointer-events: none;
  opacity: 0;
}
#toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

/* ‚îÄ‚îÄ‚îÄ INPUT SHEET ‚îÄ‚îÄ‚îÄ */
#inputSheet {
  position: fixed; inset: 0;
  z-index: 300;
  display: flex; align-items: flex-end;
  background: rgba(0,0,0,0.7);
}
.input-sheet-inner {
  background: var(--surface);
  border-radius: var(--r) var(--r) 0 0;
  border: 1px solid var(--border2);
  border-bottom: none;
  padding: 0 0 30px;
  width: 100%; max-width: 480px; margin: 0 auto;
  animation: slideModal 0.3s cubic-bezier(.4,0,.2,1);
  max-height: 85vh; overflow-y: auto;
}
.sheet-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 20px 12px;
  border-bottom: 1px solid var(--border);
  position: sticky; top: 0;
  background: var(--surface); z-index: 1;
}
.sheet-title { font-size: 0.92rem; font-weight: 700; color: var(--gold2); }
.sheet-close {
  background: none; border: none; color: var(--text3);
  font-size: 1.1rem; cursor: pointer; padding: 4px 8px;
  border-radius: 8px; transition: color 0.15s; font-family: var(--font-body);
}
.sheet-close:hover { color: var(--text); }
.sheet-body { padding: 16px 20px; }

/* v1.5 - Date picker in sheet */
.sheet-date-row {
  display: flex; align-items: center; justify-content: space-between;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: var(--r-sm); padding: 8px 12px;
  margin-bottom: 14px;
  font-size: 0.82rem; color: var(--text2);
}
.sheet-date-val { color: var(--gold2); font-weight: 600; }

/* ‚îÄ‚îÄ‚îÄ REMINDER ‚îÄ‚îÄ‚îÄ */
.reminder-item {
  display: flex; align-items: center; gap: 12px;
  padding: 10px 12px;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: var(--r-sm); margin-bottom: 8px;
  transition: border-color 0.2s;
}
.reminder-item.active { border-color: rgba(232,184,75,0.4); background: var(--gold-dim); }
.reminder-time { font-size: 1rem; font-weight: 700; color: var(--gold2); min-width: 48px; }
.reminder-label { font-size: 0.8rem; color: var(--text2); flex: 1; }  /* v1.5: was 0.75rem */
.reminder-del-btn { background: none; border: none; color: var(--text3); cursor: pointer; font-size: 1rem; }
.reminder-del-btn:hover { color: var(--red); }

/* v1.5 - Reminder status badge */
.reminder-status-bar {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: var(--r-sm); padding: 10px 14px;
  margin-bottom: 12px; font-size: 0.8rem; color: var(--text2);
  display: flex; align-items: center; gap: 8px;
}
.reminder-status-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.reminder-status-dot.granted { background: var(--green); }
.reminder-status-dot.denied { background: var(--red); }
.reminder-status-dot.default { background: var(--amber); }

/* Toggle switch */
.toggle-wrap { position: relative; display: inline-block; width: 40px; height: 22px; flex-shrink: 0; }
.toggle-wrap input { opacity: 0; width: 0; height: 0; }
.toggle-slider {
  position: absolute; cursor: pointer; inset: 0;
  background: var(--border2); border-radius: 22px;
  transition: .3s;
}
.toggle-slider:before {
  content: ""; position: absolute;
  height: 16px; width: 16px; left: 3px; bottom: 3px;
  background: var(--text3); border-radius: 50%;
  transition: .3s;
}
input:checked + .toggle-slider { background: var(--gold-dim); border: 1px solid var(--gold); }
input:checked + .toggle-slider:before { transform: translateX(18px); background: var(--gold); }

/* ‚îÄ‚îÄ‚îÄ CALCULATOR ‚îÄ‚îÄ‚îÄ */
.calc-result {
  background: var(--surface2);
  border: 1px solid var(--gold);
  border-radius: var(--r-sm);
  padding: 14px;
  margin-top: 10px;
  text-align: center;
}
.calc-result .calc-num { font-size: 2rem; font-weight: 700; color: var(--gold2); }
.calc-result .calc-label { font-size: 0.8rem; color: var(--text2); margin-top: 3px; }

/* ‚îÄ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ‚îÄ */
.empty-state { text-align: center; padding: 28px 16px; color: var(--text3); font-size: 0.84rem; }
.empty-state .empty-icon { font-size: 2.5rem; margin-bottom: 10px; display: block; }

/* ‚îÄ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ‚îÄ */
.history-day-header {
  font-size: 0.75rem; font-weight: 700; color: var(--gold);
  text-transform: uppercase; letter-spacing: 1px;
  padding: 6px 0; border-bottom: 1px solid var(--border);
  margin-bottom: 8px;
  display: flex; justify-content: space-between; align-items: center;
}
.history-day-total { color: var(--text2); font-weight: 400; text-transform: none; letter-spacing: 0; }

/* ‚îÄ‚îÄ‚îÄ CELEBRATION ‚îÄ‚îÄ‚îÄ */
#celebrationOverlay {
  position: fixed; inset: 0;
  z-index: 2000;
  background: rgba(10,14,26,0.92);
  display: flex; align-items: center; justify-content: center;
  animation: fadeIn 0.4s ease;
}
.celebration-content {
  text-align: center; padding: 32px 24px;
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: 24px;
  box-shadow: 0 0 60px var(--gold-glow);
  position: relative; z-index: 1;
  max-width: 320px; width: 90%;
}
.celebration-emoji { font-size: 3.5rem; display: block; margin-bottom: 12px; }
.celebration-title { font-family: var(--font-display); font-size: 2rem; color: var(--gold2); margin-bottom: 8px; }
.confetti-dot {
  position: absolute; width: 8px; height: 8px;
  border-radius: 50%;
  animation: confettiFall linear infinite;
  top: -20px;
}
@keyframes confettiFall {
  to { transform: translateY(110vh) rotate(720deg); opacity: 0; }
}
.confirm-check {
  position: fixed; top: 50%; left: 50%;
  transform: translate(-50%, -50%) scale(0);
  font-size: 3rem;
  z-index: 9999;
  animation: checkPop 0.8s ease forwards;
  pointer-events: none;
}
@keyframes checkPop {
  0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
  50% { transform: translate(-50%, -50%) scale(1.3); }
  80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
  100% { transform: translate(-50%, -50%) scale(1.1); opacity: 0; }
}

/* ‚îÄ‚îÄ‚îÄ VS TABLE (wizard) ‚îÄ‚îÄ‚îÄ */
.vs-row {
  display: grid; grid-template-columns: auto 1fr 1fr 1fr;
  align-items: center; gap: 8px;
  padding: 6px 0;
  border-bottom: 1px solid var(--border);
  font-size: 0.75rem;
}
.vs-row:last-child { border-bottom: none; }
.vs-icon { font-size: 1rem; }
.vs-aspect { color: var(--text2); font-weight: 600; }
.vs-manual { color: var(--text3); font-size: 0.69rem; }
.vs-app { color: var(--green); font-size: 0.69rem; }

/* ‚îÄ‚îÄ‚îÄ FONT SCALING ‚îÄ‚îÄ‚îÄ */
body.font-md { --fs-base: 15px; --fs-label: 13px; }
body.font-lg { --fs-base: 16px; --fs-label: 14px; }
body.font-md .nav-label { font-size: 0.75rem; }
body.font-lg .nav-label { font-size: 0.8rem; }
body.font-md .badge-name { font-size: 0.72rem; }
body.font-lg .badge-name { font-size: 0.78rem; }
body.font-md .card-title { font-size: 0.78rem; }
body.font-lg .card-title { font-size: 0.82rem; }
body.font-md .ac-item { font-size: 0.88rem; }
body.font-lg .ac-item { font-size: 0.94rem; }

/* ‚îÄ‚îÄ‚îÄ SMART PRAYER SUGGESTION (v1.5) ‚îÄ‚îÄ‚îÄ */
.prayer-suggest-badge {
  display: inline-block;
  background: var(--green-dim); border: 1px solid rgba(61,214,140,0.4);
  color: var(--green); border-radius: 12px;
  padding: 2px 10px; font-size: 0.69rem; font-weight: 600;
  margin-left: 8px;
}

/* ‚îÄ‚îÄ‚îÄ ONBOARDING TOUR (v1.5 - simplified highlight) ‚îÄ‚îÄ‚îÄ */
.tour-highlight {
  outline: 3px solid var(--gold);
  outline-offset: 4px;
  border-radius: var(--r-sm);
  animation: tourPulse 1s ease infinite alternate;
}
@keyframes tourPulse {
  from { outline-color: var(--gold); }
  to { outline-color: var(--gold2); }
}

/* ‚îÄ‚îÄ‚îÄ PIE CHART PLACEHOLDER (v1.5) ‚îÄ‚îÄ‚îÄ */
.prayer-pie-wrap {
  display: flex; gap: 12px; align-items: center;
  flex-wrap: wrap; margin-top: 8px;
}
.pie-legend { flex: 1; min-width: 140px; }
.pie-legend-row {
  display: flex; align-items: center; gap: 8px;
  font-size: 0.75rem; color: var(--text2);
  margin-bottom: 5px;
}
.pie-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

/* ‚îÄ‚îÄ‚îÄ LOCKED NAV TOOLTIP (v1.5 new) ‚îÄ‚îÄ‚îÄ */
.nav-locked-hint {
  position: fixed; bottom: 80px; left: 50%;
  transform: translateX(-50%);
  background: var(--surface);
  border: 1px solid var(--gold);
  border-radius: 12px;
  padding: 12px 18px;
  font-size: 0.84rem; color: var(--text);
  z-index: 200;
  box-shadow: 0 4px 24px rgba(232,184,75,0.2);
  animation: slideUp 0.3s ease;
  display: flex; align-items: center; gap: 10px;
  min-width: 220px;
  pointer-events: none;
}
.locked-hint-btn {
  background: var(--gold); color: #0a0e1a;
  border: none; border-radius: 8px;
  padding: 6px 12px; font-size: 0.75rem; font-weight: 700;
  cursor: pointer; font-family: var(--font-body);
  pointer-events: all; white-space: nowrap;
  flex-shrink: 0;
}
</style>
</head>
<body>
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     WELCOME SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="welcomeScreen">
  <div class="welcome-logo">üìñ</div>
  <h1 class="welcome-title">Target Tilawah<br>Ramadhan</h1>
  <p class="welcome-sub">Raih Khatam dengan Istiqomah</p>

  <div class="benefits-grid">
    <div class="benefit-item">
      <span class="benefit-icon">üßÆ</span>
      <div class="benefit-text">
        <strong>Kalkulasi Otomatis</strong>
        <span>Target harian dan per sholat dihitung otomatis ‚Äî kamu tinggal baca!</span>
      </div>
    </div>
    <div class="benefit-item">
      <span class="benefit-icon">üìä</span>
      <div class="benefit-text">
        <strong>Insight Personal</strong>
        <span>Tren bacaan, waktu terkonsisten, dan proyeksi khatam teranalisis otomatis</span>
      </div>
    </div>
    <div class="benefit-item">
      <span class="benefit-icon">üî•</span>
      <div class="benefit-text">
        <strong>Motivasi Adaptif</strong>
        <span>Dorongan dan saran kejar setoran disesuaikan dengan progres hari ini</span>
      </div>
    </div>
  </div>

  <button class="btn-welcome" onclick="startOnboarding()">‚ú® Mulai Penyusunan Target</button>
  <p style="margin-top:14px;font-size:0.75rem;color:var(--text3);">Gratis selamanya ‚Ä¢ Offline ‚Ä¢ Data tidak dikirim ke mana pun</p>
  <button onclick="toggleFontSize()" style="margin-top:12px;background:none;border:1px solid var(--border);border-radius:20px;padding:7px 18px;color:var(--text2);font-family:var(--font-body);font-size:0.82rem;cursor:pointer;">üî° Perbesar Huruf</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SETUP WIZARD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="setupWizard" style="display:none;">
  <div class="wizard-header">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <span style="font-size:0.78rem;color:var(--text3);">Setup Target Tilawah</span>
      <button onclick="toggleFontSize()" style="background:none;border:1px solid var(--border);border-radius:20px;padding:4px 12px;color:var(--text2);font-family:var(--font-body);font-size:0.75rem;cursor:pointer;">üî° Huruf</button>
    </div>
    <div class="wizard-step-indicator" id="stepIndicator">
      <div class="step-dot active" id="step-dot-1"></div>
      <div class="step-dot" id="step-dot-2"></div>
      <div class="step-dot" id="step-dot-3"></div>
    </div>
    <div class="wizard-step-label" id="stepLabel">Langkah <strong>1</strong> dari 3</div>
  </div>

  <div class="wizard-body">
    <!-- Step 1 -->
    <div id="wizardStep1">
      <h2 class="wizard-title">Halo! üëã</h2>
      <p class="wizard-desc">Mari kita siapkan target tilawah Ramadhan kamu. Hanya butuh 1 menit!</p>
      <div class="form-group">
        <label>Nama Panggilan <span style="color:var(--red);font-size:0.9em;">*</span></label>
        <input type="text" id="wiz_name" placeholder="Nama kamu..." maxlength="30"
          style="font-size:1rem;" oninput="wizValidateName()">
        <div id="nameError" style="color:var(--red);font-size:0.75rem;margin-top:4px;display:none;">Masukkan nama minimal 1 karakter</div>
      </div>
      <div class="form-group">
        <label id="wiz_start_label">Tanggal 1 Ramadhan</label>
        <input type="date" id="wiz_start" value="2026-02-19" onchange="wizUpdatePreview()">
      </div>
    </div>

    <!-- Step 2 -->
    <div id="wizardStep2" style="display:none;">
      <h2 class="wizard-title">Target Khatam üéØ</h2>
      <p class="wizard-desc">Berapa kali kamu ingin menyelesaikan Al-Qur'an di Ramadhan ini?</p>

      <!-- v1.5: khatam explanation box -->
      <div class="khatam-info-box">
        üìñ <strong>Apa itu Khatam?</strong><br>
        Khatam artinya membaca Al-Qur'an dari awal (Al-Fatihah) hingga akhir (An-Nas) ‚Äî seluruhnya <strong>604 halaman</strong> atau <strong>30 juz</strong>. Target 1 khatam = membaca semua halaman selama Ramadhan 30 hari.
      </div>

      <div class="card" style="margin-bottom:14px;">
        <div class="khatam-row">
          <button class="khatam-btn" onclick="wizKhatam(-1)" aria-label="Kurangi target khatam">‚àí</button>
          <div class="khatam-num-big" id="wiz_khatam_num">1</div>
          <button class="khatam-btn" onclick="wizKhatam(1)" aria-label="Tambah target khatam">+</button>
        </div>
        <div style="text-align:center;font-size:0.78rem;color:var(--text3);margin-top:4px;">khatam selama Ramadhan</div>
      </div>

      <div class="card" style="background:var(--surface2);">
        <div class="card-header"><span class="card-icon">üìã</span><span class="card-title">Preview Target Kamu</span></div>
        <div class="stat-grid" style="margin-bottom:12px;">
          <div class="stat-card"><div class="stat-val" id="wiz_daily">20</div><div class="stat-lbl">Halaman/Hari</div></div>
          <div class="stat-card"><div class="stat-val" id="wiz_total">604</div><div class="stat-lbl">Total Halaman</div></div>
          <div class="stat-card"><div class="stat-val" id="wiz_juz">1.0</div><div class="stat-lbl">Juz/Hari</div></div>
          <div class="stat-card"><div class="stat-val" id="wiz_total_juz">30</div><div class="stat-lbl">Total Juz</div></div>
        </div>
        <div id="wiz_equiv" style="text-align:center;font-size:0.8rem;color:var(--text2);margin-bottom:10px;padding:8px;background:var(--surface);border-radius:8px;"></div>
        <div class="prayer-grid" id="wiz_prayer_preview"></div>
      </div>
    </div>

    <!-- Step 3 -->
    <div id="wizardStep3" style="display:none;">
      <h2 class="wizard-title">Siap Memulai! üåô</h2>
      <p class="wizard-desc">Ini rencana tilawah kamu. Aplikasi akan melacak progres dan memberi tahu kapan perlu mengejar target.</p>

      <div class="card">
        <div id="wiz_summary_content"></div>
      </div>

      <div class="card" style="background:var(--gold-dim);border-color:rgba(232,184,75,0.3);margin-bottom:0;">
        <div class="card-header"><span class="card-icon">üí°</span><span class="card-title" style="color:var(--gold2);">Mengapa lebih baik dari buku catatan?</span></div>
        <div class="vs-row">
          <span class="vs-icon">üßÆ</span><span class="vs-aspect">Kalkulasi Target</span>
          <span class="vs-manual">Hitung sendiri setiap hari</span>
          <span class="vs-app">‚úì Otomatis, selalu akurat</span>
        </div>
        <div class="vs-row">
          <span class="vs-icon">üìà</span><span class="vs-aspect">Proyeksi Khatam</span>
          <span class="vs-manual">Tidak bisa dilakukan</span>
          <span class="vs-app">‚úì Update setiap input</span>
        </div>
        <div class="vs-row">
          <span class="vs-icon">üèÉ</span><span class="vs-aspect">Kejar Setoran</span>
          <span class="vs-manual">Hitung manual sisa hari</span>
          <span class="vs-app">‚úì Kalkulator otomatis</span>
        </div>
        <div class="vs-row">
          <span class="vs-icon">üîî</span><span class="vs-aspect">Pengingat</span>
          <span class="vs-manual">Bergantung ingatan</span>
          <span class="vs-app">‚úì Notifikasi terjadwal</span>
        </div>
      </div>
    </div>
  </div>

  <div class="wizard-footer">
    <button class="btn btn-secondary btn-auto" id="wizBackBtn" onclick="wizBack()" style="display:none;">‚Üê Kembali</button>
    <button class="btn btn-primary" id="wizNextBtn" onclick="wizNext()">Lanjut ‚Üí</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MAIN APP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="mainApp">

  <!-- HEADER -->
  <header class="app-header">
    <div class="header-top">
      <div class="header-brand">
        <span class="logo">üìñ</span>
        <div>
          <h1 id="mainTitle">Tilawah Ramadhan</h1>
          <div class="subtitle" id="mainSubtitle">1447H</div>
        </div>
      </div>
      <div style="display:flex;gap:6px;">
        <button class="header-btn" onclick="toggleFontSize()" title="Ukuran huruf" aria-label="Ubah ukuran huruf">Aa</button>
        <button class="header-btn" onclick="showSection('settings')" title="Pengaturan" aria-label="Pengaturan">‚öôÔ∏è</button>
      </div>
    </div>

    <div class="header-chips">
      <span class="chip" id="headerDate">‚Äî</span>
      <span class="chip gold" id="headerRamDay">Hari ke-1</span>
    </div>

    <div class="header-today-summary" id="headerSummary">
      <div class="today-progress-info">
        <span class="today-label">Progress Hari Ini</span>
        <span class="today-value" id="headerTodayVal">0 / 20 halaman</span>
        <div class="today-mini-bar">
          <div class="today-mini-fill on-track" id="headerMiniBar" style="width:0%"></div>
        </div>
      </div>
      <div class="today-pct" id="headerTodayPct" style="color:var(--gold2);">0%</div>
    </div>
  </header>

  <!-- SECTIONS -->
  <!-- ‚îÄ‚îÄ‚îÄ BERANDA ‚îÄ‚îÄ‚îÄ -->
  <div id="section-home" class="section active">

    <!-- Status Banner (always visible ‚Äî above fold) -->
    <div id="statusBanner" class="status-banner on-track" style="margin-top:0">
      <div class="status-icon" id="statusIcon">üìñ</div>
      <div class="status-title" id="statusTitle">Bismillah, mulai tilawah hari ini!</div>
      <div class="status-msg" id="statusMsg">Target kamu <span id="statusTarget">20</span> halaman hari ini.</div>
      <div class="status-action" id="statusAction"></div>
    </div>

    <!-- Progress Ring (always visible) -->
    <div class="card">
      <div class="card-header"><span class="card-icon">üèÜ</span><span class="card-title">Progres Keseluruhan</span><span class="card-badge" id="khatamBadge">0√ó Khatam</span></div>
      <div class="progress-ring-wrap">
        <svg width="150" height="150" viewBox="0 0 150 150" aria-label="Progress ring">
          <circle cx="75" cy="75" r="63" fill="none" stroke="var(--surface2)" stroke-width="9"/>
          <circle id="progressRingCircle" cx="75" cy="75" r="63" fill="none" stroke="url(#pgGrad)" stroke-width="9"
            stroke-linecap="round" stroke-dasharray="395.84" stroke-dashoffset="395.84"
            transform="rotate(-90 75 75)" style="transition:stroke-dashoffset 0.9s cubic-bezier(.4,0,.2,1)"/>
          <defs>
            <linearGradient id="pgGrad" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0%" stop-color="#4a90e8" id="pgG1"/>
              <stop offset="100%" stop-color="#3dd68c" id="pgG2"/>
            </linearGradient>
          </defs>
        </svg>
        <div class="ring-label">
          <div class="ring-pct" id="progressPct">0%</div>
          <div class="ring-sub" id="progressSub">Selesai</div>
        </div>
      </div>
      <div class="stat-grid">
        <div class="stat-card"><div class="stat-val" id="totalRead">0</div><div class="stat-lbl">Dibaca<br><span style="color:var(--text3);font-size:0.62rem;" id="totalReadJuz">0.0 Juz</span></div></div>
        <div class="stat-card"><div class="stat-val" id="remaining">0</div><div class="stat-lbl">Tersisa<br><span style="color:var(--text3);font-size:0.62rem;" id="remainingJuz">0.0 Juz</span></div></div>
        <div class="stat-card"><div class="stat-val" id="projDate">‚Äî</div><div class="stat-lbl">Estimasi<br>Khatam</div></div>
        <div class="stat-card"><div class="stat-val" id="avgDaily">0</div><div class="stat-lbl">Rata-rata<br>Hal/Hari</div></div>
      </div>
    </div>

    <!-- v1.5: CTA Quick Record button -->
    <button class="btn btn-primary" onclick="openInputSheet()" style="margin-bottom:12px;border-radius:50px;font-size:1rem;">
      ‚úèÔ∏è Catat Tilawah Sekarang
    </button>

    <!-- v1.5: Progressive Disclosure ‚Äî secondary content collapsed by default -->
    <button class="collapse-toggle" id="homeToggleBtn" onclick="toggleHomeDetails()" aria-expanded="false">
      <span>üìä Lihat Statistik Lengkap</span>
      <span class="toggle-arrow">‚ñº</span>
    </button>

    <div class="collapsible-section" id="homeDetails">
      <!-- Insights -->
      <div class="card" id="insightCard">
        <div class="card-header"><span class="card-icon">üí°</span><span class="card-title">Insight Harian</span></div>
        <div id="insightContent">
          <div class="empty-state"><span class="empty-icon">üìä</span>Insight tersedia setelah beberapa hari input data</div>
        </div>
      </div>

      <!-- Streak -->
      <div class="card">
        <div class="card-header"><span class="card-icon">üî•</span><span class="card-title">Streak Harian</span><span class="card-badge" id="streakBadge">0 hari</span></div>
        <div id="streakInfo" style="text-align:center;font-size:0.82rem;color:var(--text2);margin-bottom:10px;"></div>
        <!-- v1.5: calendar-style streak grid -->
        <div class="streak-bar" id="streakBar"></div>
        <div class="streak-legend">
          <span><span class="sl-dot" style="background:var(--green);"></span>Di atas target</span>
          <span><span class="sl-dot" style="background:var(--blue);border:1.5px solid var(--blue);"></span>Tepat/partial</span>
          <span><span class="sl-dot" style="background:var(--amber-dim);border:1.5px solid rgba(240,160,48,0.4);"></span>Di bawah target</span>
          <span><span class="sl-dot" style="background:var(--surface);border:1.5px dashed var(--border);"></span>Belum dimulai</span>
        </div>
      </div>

      <!-- Target per sholat -->
      <div class="card">
        <div class="card-header">
          <span class="card-icon">‚è∞</span>
          <span class="card-title">Target Per Waktu Sholat</span>
          <button class="card-action-btn" onclick="showEditBreakdown()">‚úèÔ∏è Ubah</button>
        </div>
        <div class="prayer-grid" id="prayerBreakdown"></div>
        <div id="breakdownModeNote" style="font-size:0.69rem;color:var(--text3);text-align:center;margin-top:6px;">Otomatis dihitung berdasarkan bobot</div>
      </div>

      <!-- Prayer Pie Chart (v1.5 new) -->
      <div class="card" id="prayerPieCard" style="display:none;">
        <div class="card-header"><span class="card-icon">ü•ß</span><span class="card-title">Distribusi Tilawah per Sholat</span></div>
        <div class="prayer-pie-wrap">
          <canvas id="pieCanvas" width="120" height="120"></canvas>
          <div class="pie-legend" id="pieLegend"></div>
        </div>
      </div>

      <!-- Badges -->
      <div class="card">
        <div class="card-header"><span class="card-icon">üèÖ</span><span class="card-title">Pencapaian</span></div>
        <div class="badge-grid" id="badgeGrid"></div>
        <div style="font-size:0.75rem;color:var(--text3);text-align:center;margin-top:8px;">Ketuk badge untuk melihat syarat üîç</div>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ SECTION: CATAT ‚îÄ‚îÄ‚îÄ -->
  <div id="section-input" class="section">
    <!-- Today summary card -->
    <div class="card" style="margin-top:0;">
      <div class="card-header"><span class="card-icon">üìÖ</span><span class="card-title" id="inputCardTitle">Hari Ini</span></div>
      <div style="display:flex;align-items:center;gap:14px;margin-bottom:10px;">
        <div style="flex:1;">
          <div style="font-size:0.78rem;color:var(--text2);margin-bottom:3px;">Total dibaca</div>
          <div style="font-size:1.6rem;font-weight:700;color:var(--gold2);" id="inputTodayTotal">0</div>
          <div style="font-size:0.75rem;color:var(--text2);">dari <span id="inputDailyTarget">20</span> halaman target</div>
          <div class="prog-bar-wrap" style="margin-top:6px;">
            <div class="prog-bar-fill on-track" id="inputTodayBar" style="width:0%"></div>
          </div>
        </div>
        <div style="text-align:right;">
          <div style="font-size:0.75rem;color:var(--text2);margin-bottom:3px;">Sisa hari ini</div>
          <div style="font-size:1.3rem;font-weight:700;color:var(--amber);" id="inputTodayRemain">20</div>
          <div style="font-size:0.69rem;color:var(--text3);">halaman lagi</div>
        </div>
      </div>

      <!-- Date picker -->
      <div style="margin-top:4px;">
        <label>Catat untuk Tanggal</label>
        <input type="date" id="logDate" onchange="onLogDateChange()" style="margin-bottom:0;">
      </div>
    </div>

    <!-- Backfill Banner -->
    <div class="backfill-banner" id="backfillBanner" style="display:none;">
      <span class="backfill-icon">üìù</span>
      <div class="backfill-content">
        <div class="backfill-title">Ada hari yang belum tercatat</div>
        <div class="backfill-text" id="backfillText"></div>
        <button class="backfill-btn" onclick="openBackfillGuide()">üìñ Cara Isi Hari Sebelumnya</button>
        <button onclick="dismissBackfill()" style="background:none;border:none;color:var(--text3);font-size:0.75rem;cursor:pointer;margin-left:8px;font-family:var(--font-body);">Tutup</button>
      </div>
    </div>

    <!-- Input Form -->
    <div class="card">
      <div class="card-header"><span class="card-icon">‚úèÔ∏è</span><span class="card-title">Tambah Tilawah</span></div>

      <div class="form-row" style="margin-bottom:12px;">
        <div>
          <label>Waktu Sholat <span id="smartSuggestionBadge" class="prayer-suggest-badge" style="display:none;">Otomatis</span></label>
          <select id="prayerSelect" onchange="updatePrayerHint()">
            <option value="Subuh">üåÖ Subuh</option>
            <option value="Dhuha">‚òÄÔ∏è Dhuha</option>
            <option value="Dzuhur">üå§Ô∏è Dzuhur</option>
            <option value="Ashar">üåÜ Ashar</option>
            <option value="Maghrib">üåá Maghrib</option>
            <option value="Tarawih">üåô Tarawih</option>
          </select>
          <div id="prayerHint" style="font-size:0.75rem;color:var(--text3);margin-top:3px;"></div>
        </div>
        <div>
          <label>Jumlah Halaman</label>
          <input type="number" id="pagesInput" min="1" max="604" placeholder="0" inputmode="numeric"
            style="font-size:1.4rem;font-weight:700;text-align:center;padding:8px;">
        </div>
      </div>

      <label style="margin-bottom:4px;">‚ö° Pilih Cepat</label>
      <div style="font-size:0.75rem;color:var(--text2);margin-bottom:8px;">Ketuk untuk langsung mengisi kolom halaman</div>
      <div class="quick-btns">
        <button class="quick-btn" onclick="quickInput(2)">2 hal</button>
        <button class="quick-btn" onclick="quickInput(4)">4 hal</button>
        <button class="quick-btn" onclick="quickInput(8)">8 hal</button>
        <button class="quick-btn" onclick="quickInput(20)">1 Juz</button>
      </div>

      <div class="form-group">
        <label>Posisi Baca (opsional)</label>
        <div class="autocomplete-wrap">
          <input type="text" id="lastPosInput" placeholder="Cth: Al-Baqarah, Al-Kahfi..." autocomplete="off"
            oninput="onPosInput(this)" onkeydown="onPosKey(event)" onblur="hidePosDropdown(event)">
          <div class="autocomplete-dropdown" id="posDropdown"></div>
        </div>
      </div>

      <button class="btn btn-primary" onclick="addLog()" aria-label="Simpan catatan tilawah">+ Tambah Tilawah</button>
    </div>

    <!-- Today's Log -->
    <div class="card">
      <div class="card-header">
        <span class="card-icon">üìã</span>
        <span class="card-title" id="logCardTitle">Log Hari Ini</span>
        <span style="font-size:0.82rem;font-weight:700;color:var(--blue);" id="todayTotalBottom">0 Halaman</span>
      </div>
      <div id="todayLog"></div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ SECTION: RIWAYAT ‚îÄ‚îÄ‚îÄ -->
  <div id="section-history" class="section">
    <!-- Daily Bar Chart -->
    <div class="card" style="margin-top:0;">
      <div class="card-header"><span class="card-icon">üìà</span><span class="card-title">Grafik Harian</span></div>
      <div class="chart-wrap">
        <div class="chart-bars" id="dailyChart"></div>
      </div>
    </div>

    <!-- Weekly Summary -->
    <div class="card">
      <div class="card-header"><span class="card-icon">üìÖ</span><span class="card-title">Ringkasan Mingguan</span></div>
      <div id="weeklySummary"></div>
    </div>

    <!-- Trend Mingguan -->
    <div class="card">
      <div class="card-header"><span class="card-icon">üìâ</span><span class="card-title">Tren Mingguan</span></div>
      <div class="trend-wrap">
        <div class="trend-cols" id="trendCols"></div>
        <div class="trend-target-line" id="trendTargetLine" style="display:none;"></div>
      </div>
      <div class="trend-legend" id="trendLegend"></div>
    </div>

    <!-- Detail Log -->
    <div class="card">
      <div class="card-header">
        <span class="card-icon">üîç</span>
        <span class="card-title">Detail Per Hari</span>
        <div style="display:flex;gap:4px;margin-left:auto;">
          <button onclick="navHistory(-1)" style="background:none;border:1px solid var(--border);border-radius:6px;padding:2px 8px;color:var(--text2);cursor:pointer;font-family:var(--font-body);font-size:0.8rem;">‚Äπ</button>
          <button onclick="navHistory(1)" style="background:none;border:1px solid var(--border);border-radius:6px;padding:2px 8px;color:var(--text2);cursor:pointer;font-family:var(--font-body);font-size:0.8rem;">‚Ä∫</button>
        </div>
      </div>
      <select id="historyDateSelect" onchange="renderHistoryDetail()" style="margin-bottom:12px;"></select>
      <div id="historyDetail"></div>
    </div>

    <!-- Riwayat Tahun -->
    <div class="card">
      <div class="card-header"><span class="card-icon">üåô</span><span class="card-title">Riwayat Ramadhan</span></div>
      <div id="yearHistory"></div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ SECTION: BAGIKAN ‚îÄ‚îÄ‚îÄ -->
  <div id="section-share" class="section">
    <!-- Share Card Canvas -->
    <div class="card" style="margin-top:0;">
      <div class="card-header"><span class="card-icon">üñºÔ∏è</span><span class="card-title">Kartu Progres</span></div>
      <canvas id="shareCanvas" width="700" height="440" style="border-radius:var(--r);max-width:100%;display:block;margin:0 auto;"></canvas>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px;">
        <button class="btn btn-primary" style="margin:0;" onclick="shareProgressCard()">üì§ Bagikan</button>
        <button class="btn btn-secondary" style="margin:0;" onclick="downloadCanvas()">üì• Simpan</button>
      </div>
    </div>

    <!-- Share App -->
    <div class="card">
      <div class="card-header"><span class="card-icon">üîó</span><span class="card-title">Bagikan Aplikasi</span></div>
      <div style="font-size:0.84rem;color:var(--text2);margin-bottom:14px;line-height:1.6;">
        Ajak teman &amp; keluarga untuk ikut melacak tilawah Ramadhan mereka. Gratis dan tidak perlu instalasi.
      </div>
      <div style="background:var(--surface2);border-radius:var(--r-sm);padding:12px 14px;margin-bottom:14px;display:flex;align-items:center;gap:10px;">
        <span style="font-size:1.2rem;">üåê</span>
        <div style="flex:1;min-width:0;">
          <div style="font-size:0.72rem;color:var(--text3);margin-bottom:2px;">Link Aplikasi</div>
          <div style="font-size:0.82rem;color:var(--gold2);word-break:break-all;font-weight:600;" id="appLinkDisplay">https://mitrawashlaundry-code.github.io/tilawah-ramadhan/</div>
        </div>
        <button onclick="copyAppLink()" style="background:var(--gold-dim);border:1px solid var(--gold);color:var(--gold2);border-radius:8px;padding:6px 10px;font-size:0.75rem;white-space:nowrap;cursor:pointer;font-family:var(--font-body);">üìã Salin</button>
      </div>
      <button class="btn btn-primary" onclick="shareAppLink()">üöÄ Bagikan ke...</button>
    </div>

    <!-- Export CSV -->
    <div class="card">
      <div class="card-header"><span class="card-icon">üìä</span><span class="card-title">Export Data ke CSV</span></div>
      <div style="font-size:0.84rem;color:var(--text2);margin-bottom:14px;line-height:1.6;">
        Unduh riwayat tilawah sebagai file yang bisa dibuka di <strong style="color:var(--text);">Excel, Google Sheets</strong>, atau aplikasi tabel lainnya.
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
        <button class="btn btn-blue" style="margin:0;" onclick="exportCSV('detail')">üìã Export Detail</button>
        <button class="btn btn-secondary" style="margin:0;" onclick="exportCSV('summary')">üìÖ Export Harian</button>
      </div>
      <div style="font-size:0.72rem;color:var(--text3);margin-top:10px;line-height:1.5;">
        üí° <strong>Detail:</strong> tiap sesi baca satu baris. &nbsp;<strong>Harian:</strong> satu baris per hari selama 30 hari.
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ SECTION: PENGATURAN ‚îÄ‚îÄ‚îÄ -->
  <div id="section-settings" class="section">
    <!-- Setup info -->
    <div class="card" style="margin-top:0;" id="setupInfoCard">
      <div class="card-header"><span class="card-icon">‚öôÔ∏è</span><span class="card-title">Pengaturan Target</span></div>
      <div style="font-size:0.84rem;color:var(--text2);margin-bottom:12px;line-height:1.8;">
        Nama: <strong style="color:var(--text);" id="settingNameDisplay">‚Äî</strong><br>
        Target: <strong style="color:var(--gold2);" id="settingKhatamDisplay">1 khatam</strong><br>
        Mulai Ramadhan: <strong style="color:var(--text);" id="settingStartDisplay">‚Äî</strong>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="showEditSetup()">‚úèÔ∏è Ubah Pengaturan</button>
    </div>

    <!-- Kalkulator Kejar Setoran -->
    <div class="card">
      <div class="card-header"><span class="card-icon">üèÉ</span><span class="card-title">Kalkulator Kejar Setoran</span></div>
      <div style="font-size:0.82rem;color:var(--text2);margin-bottom:12px;line-height:1.6;">Hitung berapa halaman per hari yang perlu dibaca untuk mengejar target khatam.</div>
      <div class="form-group">
        <label>Sisa hari Ramadhan</label>
        <input type="number" id="calcDays" placeholder="Cth: 15" min="1" max="30" inputmode="numeric" onchange="calcCatchUp()">
      </div>
      <div id="calcResult" style="display:none;">
        <div class="calc-result">
          <div class="calc-num" id="calcNum">0</div>
          <div class="calc-label" id="calcLabel">halaman/hari yang dibutuhkan</div>
        </div>
        <div id="calcAdvice" style="font-size:0.82rem;color:var(--text2);margin-top:8px;line-height:1.5;"></div>
      </div>
    </div>

    <!-- Statistik -->
    <div class="card">
      <div class="card-header"><span class="card-icon">üìä</span><span class="card-title">Statistik Penggunaan</span></div>
      <div id="usageStats">
        <div class="insight-row"><span class="insight-icon">‚úèÔ∏è</span><span class="insight-text">Total log yang dicatat: <strong id="statTotalLogs">0</strong></span></div>
        <div class="insight-row"><span class="insight-icon">üßÆ</span><span class="insight-text" id="statCalcSaved">Kalkulasi otomatis: <strong>0</strong></span></div>
        <div class="insight-row"><span class="insight-icon">üåô</span><span class="insight-text">Waktu terbanyak membaca: <strong id="statBestPrayer">‚Äî</strong></span></div>
        <div class="insight-row"><span class="insight-icon">üìÖ</span><span class="insight-text">Hari terkonsisten: <strong id="statBestDay">‚Äî</strong></span></div>
      </div>
    </div>

    <!-- Backup & Restore (v1.5: moved from share tab) -->
    <div class="card">
      <div class="card-header"><span class="card-icon">‚òÅÔ∏è</span><span class="card-title">Simpan &amp; Pulihkan Data</span></div>
      <div style="font-size:0.84rem;color:var(--text2);margin-bottom:14px;line-height:1.6;">
        Simpan data tilawah ke file agar aman, lalu pulihkan di HP atau tablet lain.
        <br><strong style="color:var(--amber);">üí° Tips:</strong> Simpan sebelum ganti HP.
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
        <button class="btn btn-blue" style="margin:0;" onclick="backupData()">‚¨ÜÔ∏è Simpan Data</button>
        <button class="btn btn-secondary" style="margin:0;" onclick="triggerRestoreData()">‚¨áÔ∏è Pulihkan Data</button>
      </div>
      <input type="file" id="restoreFileInput" accept=".json" style="display:none;" onchange="restoreData(event)">
      <div style="font-size:0.72rem;color:var(--text3);margin-top:10px;line-height:1.5;">
        Untuk pindah HP: Simpan ‚Üí kirim file via WA/Drive ‚Üí buka app di HP baru ‚Üí Pulihkan.
      </div>
    </div>

    <!-- Reminder (v1.5: with status) -->
    <div class="card">
      <div class="card-header"><span class="card-icon">üîî</span><span class="card-title">Pengingat Tilawah</span></div>
      <!-- v1.5: Notification status display -->
      <div class="reminder-status-bar" id="reminderStatusBar">
        <div class="reminder-status-dot default" id="reminderStatusDot"></div>
        <span id="reminderStatusText" style="flex:1;">Status notifikasi: Belum diminta</span>
        <button onclick="requestNotifPermission()" id="notifPermBtn" style="background:var(--gold-dim);border:1px solid var(--gold);color:var(--gold2);border-radius:8px;padding:4px 10px;font-size:0.72rem;cursor:pointer;font-family:var(--font-body);">Izinkan</button>
      </div>
      <!-- Reminder hint for non-PWA -->
      <div id="reminderPwaTip" style="display:none;font-size:0.78rem;color:var(--text2);background:var(--amber-dim);border:1px solid rgba(240,160,48,0.3);border-radius:var(--r-sm);padding:10px 12px;margin-bottom:10px;line-height:1.6;">
        ‚ö†Ô∏è <strong>Catatan:</strong> Notifikasi di browser biasa terbatas. Untuk notifikasi yang lebih andal, pasang aplikasi ini di homescreen kamu.
      </div>
      <div id="reminderList"></div>
      <button class="btn btn-ghost btn-sm" onclick="addReminder()" style="margin-top:6px;">+ Tambah Pengingat</button>
    </div>

    <!-- Install Homescreen -->
    <div class="card">
      <div class="card-header"><span class="card-icon">üì≤</span><span class="card-title">Pasang di Homescreen</span></div>
      <div style="font-size:0.8rem;color:var(--text2);line-height:1.8;margin-bottom:10px;">
        <div><strong style="color:var(--gold2);">Android Chrome:</strong> Menu ‚ãÆ ‚Üí Tambahkan ke layar utama</div>
        <div><strong style="color:var(--gold2);">iPhone Safari:</strong> Bagikan ‚¨Ü ‚Üí Tambahkan ke Layar Utama</div>
        <div style="margin-top:8px;padding:8px 10px;background:var(--gold-dim);border:1px solid rgba(232,184,75,0.25);border-radius:var(--r-sm);">
          üåô Setelah dipasang, ikon bulan sabit emas akan muncul di homescreen.
        </div>
      </div>
      <button class="btn btn-blue btn-sm" id="installBtn" onclick="triggerInstall()" style="display:none;">üì≤ Pasang Sekarang</button>
    </div>

    <!-- Font Size -->
    <div class="card">
      <div class="card-header"><span class="card-icon">üî°</span><span class="card-title">Ukuran Huruf</span></div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-secondary btn-sm" style="margin:0;flex:1;" onclick="setFontLevel(0)">Normal</button>
        <button class="btn btn-secondary btn-sm" style="margin:0;flex:1;" onclick="setFontLevel(1)">Besar</button>
        <button class="btn btn-secondary btn-sm" style="margin:0;flex:1;" onclick="setFontLevel(2)">Sangat Besar</button>
      </div>
    </div>

    <!-- Reset -->
    <div class="card">
      <div class="card-header"><span class="card-icon">‚ö†Ô∏è</span><span class="card-title">Kelola Data</span></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
        <button class="btn btn-secondary btn-sm" onclick="confirmResetProgress()" style="margin:0;">üîÑ Reset Bacaan</button>
        <button class="btn btn-danger btn-sm" onclick="confirmResetAll()" style="margin:0;">‚ö†Ô∏è Reset Semua</button>
      </div>
    </div>

    <div style="text-align:center;padding:16px 0;font-size:0.72rem;color:var(--text3);">
      Target Tilawah Ramadhan v1.5.1<br>Semua data tersimpan di perangkat Anda
    </div>
  </div>

</div><!-- end mainApp -->

<!-- BOTTOM NAV -->
<nav class="bottom-nav" id="bottomNav" style="display:none;">
  <button class="nav-item active" id="nav-home" onclick="showSection('home')" aria-label="Beranda">
    <span class="nav-icon">üè†</span>
    <span class="nav-label">Beranda</span>
  </button>
  <button class="nav-item locked" id="nav-input" onclick="navGuard('input')" aria-label="Catat tilawah">
    <span class="nav-icon">‚úèÔ∏è</span>
    <span class="nav-label">Catat</span>
  </button>
  <button class="nav-item locked" id="nav-history" onclick="navGuard('history')" aria-label="Riwayat">
    <span class="nav-icon">üìà</span>
    <span class="nav-label">Riwayat</span>
  </button>
  <button class="nav-item locked" id="nav-share" onclick="navGuard('share')" aria-label="Bagikan">
    <span class="nav-icon">üì≤</span>
    <span class="nav-label">Bagikan</span>
  </button>
  <button class="nav-item" id="nav-settings" onclick="showSection('settings')" aria-label="Pengaturan">
    <span class="nav-icon">‚öôÔ∏è</span>
    <span class="nav-label">Pengaturan</span>
  </button>
</nav>

<!-- FAB -->
<button class="fab" id="fabBtn" onclick="openInputSheet()" title="Catat Tilawah" aria-label="Catat tilawah" style="display:none;">‚úèÔ∏è</button>

<!-- INPUT SHEET (FAB) -->
<div id="inputSheet" style="display:none;" onclick="closeSheetBg(event)">
  <div class="input-sheet-inner">
    <div class="sheet-header">
      <span class="sheet-title">‚úèÔ∏è Catat Tilawah</span>
      <button class="sheet-close" onclick="closeInputSheet()">‚úï</button>
    </div>
    <div class="sheet-body">
      <!-- v1.5: date picker in sheet -->
      <div class="sheet-date-row">
        <span>üìÖ Tanggal:</span>
        <input type="date" id="sheetDate" style="background:none;border:none;color:var(--gold2);font-family:var(--font-body);font-size:0.84rem;font-weight:600;outline:none;width:auto;padding:0;cursor:pointer;" onchange="onSheetDateChange()">
      </div>

      <div class="form-row" style="margin-bottom:12px;">
        <div>
          <label>Waktu Sholat <span id="sheetSuggestBadge" class="prayer-suggest-badge" style="display:none;">Otomatis</span></label>
          <select id="sheetPrayer">
            <option value="Subuh">üåÖ Subuh</option>
            <option value="Dhuha">‚òÄÔ∏è Dhuha</option>
            <option value="Dzuhur">üå§Ô∏è Dzuhur</option>
            <option value="Ashar">üåÜ Ashar</option>
            <option value="Maghrib">üåá Maghrib</option>
            <option value="Tarawih">üåô Tarawih</option>
          </select>
        </div>
        <div>
          <label>Halaman</label>
          <input type="number" id="sheetPages" min="1" max="604" placeholder="0" inputmode="numeric"
            style="font-size:1.4rem;font-weight:700;text-align:center;padding:8px;">
        </div>
      </div>

      <label style="margin-bottom:4px;">‚ö° Pilih Cepat</label>
      <div class="quick-btns">
        <button class="quick-btn" onclick="sheetQuickInput(2)">2 hal</button>
        <button class="quick-btn" onclick="sheetQuickInput(4)">4 hal</button>
        <button class="quick-btn" onclick="sheetQuickInput(8)">8 hal</button>
        <button class="quick-btn" onclick="sheetQuickInput(20)">1 Juz</button>
      </div>

      <div class="form-group">
        <label>Posisi Baca (opsional)</label>
        <div class="autocomplete-wrap">
          <input type="text" id="sheetPos" placeholder="Cth: Al-Baqarah, Al-Kahfi..." autocomplete="off"
            oninput="onPosInput(this)" onkeydown="onPosKey(event)" onblur="hidePosDropdown(event)">
          <div class="autocomplete-dropdown" id="posDropdownSheet"></div>
        </div>
      </div>

      <button class="btn btn-primary" onclick="addLogFromSheet()">+ Simpan Tilawah</button>
    </div>
  </div>
</div>

<!-- SHARE ACTION SHEET -->
<div id="shareSheet" style="display:none;" onclick="closeShareSheetBg(event)">
  <div class="share-sheet-inner">
    <div class="share-sheet-title" id="shareSheetTitle">Bagikan ke</div>
    <div class="share-options" id="shareOptions"></div>
    <button class="share-cancel" onclick="closeShareSheet()">Batal</button>
  </div>
</div>

<!-- MODAL -->
<div id="modalBackdrop" class="modal-backdrop hidden" onclick="closeModalBg(event)">
  <div class="modal" id="modalBox">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modalTitle"></div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-actions" id="modalActions"></div>
  </div>
</div>

<!-- Locked Nav Hint (v1.5 new) -->
<div id="lockedNavHint" style="display:none;" class="nav-locked-hint">
  <span style="flex:1;font-size:0.84rem;">‚öôÔ∏è Selesaikan setup dulu untuk akses fitur ini</span>
  <button class="locked-hint-btn" onclick="goToSetup()">Mulai Setup ‚Üí</button>
</div>

<div id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS ‚Äî v1.5.0
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const APP_VERSION = '1.5.1';
const APP_LINK = 'https://mitrawashlaundry-code.github.io/tilawah-ramadhan/';

const PRAYERS = [
  {name:'Subuh',emoji:'üåÖ'},{name:'Dhuha',emoji:'‚òÄÔ∏è'},{name:'Dzuhur',emoji:'üå§Ô∏è'},
  {name:'Ashar',emoji:'üåÜ'},{name:'Maghrib',emoji:'üåá'},{name:'Tarawih',emoji:'üåô'}
];
const PRAYER_WEIGHTS = {Subuh:2.5,Dhuha:1,Dzuhur:1,Ashar:1,Maghrib:1.5,Tarawih:2};
const PAGES_PER_KHATAM = 604;
const DAYS_RAMADHAN = 30;
const HIJRI_LOOKUP = [
  {masehi:'2024-03-11',hijri:1445},{masehi:'2025-03-01',hijri:1446},
  {masehi:'2026-02-19',hijri:1447},{masehi:'2027-02-09',hijri:1448},
  {masehi:'2028-01-29',hijri:1449},{masehi:'2029-01-17',hijri:1450},
];
const BADGES = [
  {id:'first_log',emoji:'üìñ',name:'Langkah Pertama',desc:'Input tilawah pertama',criterion:'Simpan 1 catatan tilawah'},
  {id:'streak3',emoji:'üî•',name:'Konsisten 3 Hari',desc:'3 hari berturut-turut',criterion:'Capai target 3 hari berturut-turut'},
  {id:'streak7',emoji:'üí´',name:'Seminggu Penuh',desc:'7 hari berturut-turut',criterion:'Capai target 7 hari berturut-turut'},
  {id:'half_khatam',emoji:'üåô',name:'Setengah Jalan',desc:'Baca 50% target',criterion:'Baca 50% dari total target halaman'},
  {id:'first_khatam',emoji:'üèÜ',name:'Khatam Pertama',desc:'Selesaikan 1 khatam',criterion:'Baca 604 halaman (1 khatam penuh)'},
  {id:'on_track_5',emoji:'üéØ',name:'On Track',desc:'5 hari tepat target',criterion:'Capai minimal 90% target di 5 hari berbeda'},
];

// Prayer colors for pie chart
const PRAYER_COLORS = {
  Subuh:'#4a90e8', Dhuha:'#f5d06e', Dzuhur:'#3dd68c',
  Ashar:'#f0a030', Maghrib:'#e85454', Tarawih:'#a78bfa'
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let S = {
  userName: '', startDate: '2026-02-19', khatamTarget: 1,
  totalTarget: PAGES_PER_KHATAM, dailyTarget: 20,
  totalRead: 0, currentKhatam: 0,
  dailyLogs: {}, reminders: [], earnedBadges: [],
  yearHistory: [], modeSet: false, breakdown: {},
  customBreakdown: null
};

let wizStep = 1, wizKhatamVal = 1;
let deferredInstall = null;
let _shareCanvasDirty = true;
let _activeInputDate = null;
let _backfillDismissed = false;
let _homeDetailsOpen = false;
let _lockedHintTimer = null;
let _lastSheetPrayer = 'Subuh'; // v1.5: remember last prayer

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FONT SIZE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let fontLevel = parseInt(localStorage.getItem('tilawah_fontLevel') || '0');
(function applyFontLevel() {
  document.body.className = document.body.className.replace(/font-\w+/g,'').trim();
  if (fontLevel === 1) document.body.classList.add('font-md');
  if (fontLevel === 2) document.body.classList.add('font-lg');
})();

function setFontLevel(level) {
  fontLevel = level;
  localStorage.setItem('tilawah_fontLevel', fontLevel);
  document.body.className = document.body.className.replace(/font-\w+/g,'').trim();
  if (fontLevel === 1) document.body.classList.add('font-md');
  if (fontLevel === 2) document.body.classList.add('font-lg');
  const labels = ['Normal', 'Besar', 'Sangat Besar'];
  showToast('Huruf: ' + labels[fontLevel]);
}
function toggleFontSize() {
  setFontLevel((fontLevel + 1) % 3);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATE HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function localDate(d) {
  return (d || new Date()).toLocaleDateString('en-CA');
}
function getHijriYear(d) {
  const t = new Date(d).getTime();
  let best = HIJRI_LOOKUP[0];
  for (const e of HIJRI_LOOKUP) {
    if (Math.abs(new Date(e.masehi) - t) < Math.abs(new Date(best.masehi) - t)) best = e;
  }
  return best.hijri + Math.round((t - new Date(best.masehi).getTime()) / 86400000 / 354.367);
}
function getRamLabel() { return 'Ramadhan ' + getHijriYear(S.startDate) + 'H'; }
function getRamadhanDay() {
  const today = new Date(localDate() + 'T00:00:00');
  const start = new Date(S.startDate + 'T00:00:00');
  return Math.max(1, Math.min(Math.floor((today - start) / 86400000) + 1, DAYS_RAMADHAN));
}
function getDaysGone() {
  const today = new Date(localDate() + 'T00:00:00');
  const start = new Date(S.startDate + 'T00:00:00');
  return Math.max(0, Math.min(Math.floor((today - start) / 86400000) + 1, DAYS_RAMADHAN));
}
function getDaysLeft() { return Math.max(0, DAYS_RAMADHAN - getDaysGone()); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function save() { localStorage.setItem('tilawahV3', JSON.stringify(S)); }
function load() {
  try {
    const d = localStorage.getItem('tilawahV3');
    if (d) S = { ...S, ...JSON.parse(d) };
  } catch(e) { /* silent ‚Äî corrupt data protection */ }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function el(id) { return document.getElementById(id); }
function setText(id, val) { const e = el(id); if (e) e.textContent = val; }
function setHTML(id, val) { const e = el(id); if (e) e.innerHTML = val; }
function getTodayPages(dateStr) {
  return (S.dailyLogs[dateStr] || []).reduce((s,l) => s + l.pages, 0);
}
function getStatusClass(read, target) {
  if (read >= target) return 'ahead';
  if (read >= target * 0.8) return 'on-track';
  return 'behind';
}

// ‚îÄ‚îÄ‚îÄ calcBreakdown (fixed rounding) ‚îÄ‚îÄ‚îÄ
function calcBreakdown(daily) {
  const MAGHRIB_MAX = 6;
  const totalW = Object.values(PRAYER_WEIGHTS).reduce((a,b) => a+b, 0);
  const bd = {};
  let assigned = 0;
  PRAYERS.forEach((p, i) => {
    let pg;
    if (i === PRAYERS.length - 1) {
      pg = Math.max(0, daily - assigned); // remainder goes to Tarawih
    } else {
      pg = Math.max(0, Math.round((PRAYER_WEIGHTS[p.name] / totalW) * daily));
    }
    bd[p.name] = pg;
    assigned += pg;
  });
  // Cap Maghrib & redistribution
  if (bd['Maghrib'] > MAGHRIB_MAX) {
    const excess = bd['Maghrib'] - MAGHRIB_MAX;
    bd['Maghrib'] = MAGHRIB_MAX;
    bd['Tarawih'] = Math.max(0, (bd['Tarawih'] || 0) + excess);
  }
  return bd;
}

// ‚îÄ‚îÄ‚îÄ Unified streak helper (BUG-003 fix) ‚îÄ‚îÄ‚îÄ
// mode: 'above' = only count days at/above target, 'any' = count days with any reading
function getStreakCount(mode) {
  const todayStr = localDate();
  let streak = 0, cur = 0;
  for (let i = 0; i < DAYS_RAMADHAN; i++) {
    const dt = new Date(S.startDate + 'T00:00:00');
    dt.setDate(dt.getDate() + i);
    const ds = dt.toLocaleDateString('en-CA');
    if (ds > todayStr) break;
    const pages = getTodayPages(ds);
    const qualifies = mode === 'above' ? pages >= S.dailyTarget : pages > 0;
    if (qualifies) { cur++; streak = Math.max(streak, cur); }
    else { cur = 0; }
  }
  return streak;
}

// ‚îÄ‚îÄ‚îÄ Smart prayer suggestion (v1.5 new) ‚îÄ‚îÄ‚îÄ
function getSuggestedPrayer() {
  const h = new Date().getHours();
  if (h >= 3 && h < 7) return 'Subuh';
  if (h >= 7 && h < 11) return 'Dhuha';
  if (h >= 11 && h < 15) return 'Dzuhur';
  if (h >= 15 && h < 18) return 'Ashar';
  if (h >= 18 && h < 20) return 'Maghrib';
  return 'Tarawih';
}

// ‚îÄ‚îÄ‚îÄ CSV escape helper (BUG-004 fix) ‚îÄ‚îÄ‚îÄ
function csvEscape(val) {
  const str = String(val == null ? '' : val);
  if (str.includes(',') || str.includes('"') || str.includes('\n')) {
    return '"' + str.replace(/"/g, '""') + '"';
  }
  return str;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ACTIVE INPUT DATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getActiveInputDate() { return _activeInputDate || localDate(); }
function setActiveInputDate(d) {
  _activeInputDate = d || localDate();
  const logDateEl = el('logDate');
  if (logDateEl) logDateEl.value = _activeInputDate;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ONBOARDING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startOnboarding() {
  el('welcomeScreen').style.display = 'none';
  el('setupWizard').style.display = 'flex';
  wizUpdatePreview();
  updateWizStartLabel();
}
function updateWizStartLabel() {
  const d = el('wiz_start')?.value || S.startDate;
  const lbl = el('wiz_start_label');
  if (lbl) lbl.textContent = 'Tanggal 1 Ramadhan ' + getHijriYear(d) + 'H';
}
function wizValidateName() {
  const name = el('wiz_name')?.value.trim();
  const err = el('nameError');
  if (err) err.style.display = name ? 'none' : 'block';
}
function wizKhatam(delta) {
  wizKhatamVal = Math.max(1, Math.min(5, wizKhatamVal + delta));
  setText('wiz_khatam_num', wizKhatamVal);
  wizUpdatePreview();
}
function wizUpdatePreview() {
  updateWizStartLabel();
  const total = wizKhatamVal * PAGES_PER_KHATAM;
  const daily = Math.ceil(total / DAYS_RAMADHAN);
  const juzDay = (daily / (PAGES_PER_KHATAM / 30)).toFixed(1);
  if (el('wiz_daily')) {
    setText('wiz_daily', daily);
    setText('wiz_total', total);
    setText('wiz_juz', juzDay);
    setText('wiz_total_juz', wizKhatamVal * 30);
    // v1.5: plain language equivalent
    const equiv = el('wiz_equiv');
    if (equiv) {
      const minsPerPage = 3;
      const minsDaily = daily * minsPerPage;
      equiv.textContent = `‚âà ${minsDaily} menit baca per hari (${Math.round(minsDaily/60*10)/10} jam), dibagi ke 6 waktu sholat`;
    }
    renderPrayerPreview('wiz_prayer_preview', daily);
  }
}
function renderPrayerPreview(containerId, daily) {
  const container = el(containerId);
  if (!container) return;
  const bd = calcBreakdown(daily);
  container.innerHTML = PRAYERS.map(p => {
    const pg = bd[p.name] || 0;
    return `<div class="prayer-item">
      <span class="prayer-emoji">${p.emoji}</span>
      <div class="prayer-name">${p.name}</div>
      <div class="prayer-pages">${pg}<span> hal</span></div>
    </div>`;
  }).join('');
}
function wizNext() {
  if (wizStep === 1) {
    const name = el('wiz_name')?.value.trim();
    if (!name) {
      el('nameError').style.display = 'block';
      el('wiz_name').focus();
      showToast('‚ö†Ô∏è Masukkan nama kamu dulu!');
      return;
    }
    wizStep = 2;
    el('wizardStep1').style.display = 'none';
    el('wizardStep2').style.display = '';
    wizUpdatePreview();
  } else if (wizStep === 2) {
    wizStep = 3;
    el('wizardStep2').style.display = 'none';
    el('wizardStep3').style.display = '';
    renderWizSummary();
    el('wizNextBtn').textContent = '‚úÖ Mulai Tilawah!';
  } else if (wizStep === 3) {
    finalizeSetup();
    return;
  }
  updateWizHeader();
}
function wizBack() {
  if (wizStep === 2) {
    wizStep = 1;
    el('wizardStep2').style.display = 'none';
    el('wizardStep1').style.display = '';
    el('wizNextBtn').textContent = 'Lanjut ‚Üí';
  } else if (wizStep === 3) {
    wizStep = 2;
    el('wizardStep3').style.display = 'none';
    el('wizardStep2').style.display = '';
    el('wizNextBtn').textContent = 'Lanjut ‚Üí';
  }
  updateWizHeader();
}
function updateWizHeader() {
  document.querySelectorAll('.step-dot').forEach((d, i) => {
    d.className = 'step-dot';
    if (i < wizStep-1) d.classList.add('done');
    else if (i === wizStep-1) d.classList.add('active');
  });
  el('stepLabel').innerHTML = `Langkah <strong>${wizStep}</strong> dari 3`;
  el('wizBackBtn').style.display = wizStep > 1 ? '' : 'none';
}
function renderWizSummary() {
  const name = el('wiz_name')?.value.trim();
  const start = el('wiz_start')?.value;
  const total = wizKhatamVal * PAGES_PER_KHATAM;
  const daily = Math.ceil(total / DAYS_RAMADHAN);
  setHTML('wiz_summary_content', `
    <div style="font-size:0.86rem;color:var(--text2);line-height:2.1;">
      üë§ <strong style="color:var(--text);">${name}</strong><br>
      üåô Ramadhan mulai: <strong style="color:var(--gold2);">${start}</strong><br>
      üéØ Target: <strong style="color:var(--gold2);">${wizKhatamVal}√ó khatam</strong> (${total} halaman)<br>
      üìñ Harus baca: <strong style="color:var(--gold2);">${daily} halaman/hari</strong>
    </div>`);
}
function finalizeSetup() {
  S.userName = el('wiz_name')?.value.trim();
  S.startDate = el('wiz_start')?.value;
  S.khatamTarget = wizKhatamVal;
  S.totalTarget = wizKhatamVal * PAGES_PER_KHATAM;
  S.dailyTarget = Math.ceil(S.totalTarget / DAYS_RAMADHAN);
  S.modeSet = true;
  S.customBreakdown = null; // always reset on setup
  S.breakdown = calcBreakdown(S.dailyTarget);
  save();
  el('setupWizard').style.display = 'none';
  launchMainApp();
  showToast(`‚úÖ Selamat datang, ${S.userName}! üåô`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LAUNCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function launchMainApp() {
  el('mainApp').style.display = 'block';
  el('bottomNav').style.display = 'flex';
  unlockNav();
  setActiveInputDate(localDate());
  updateAllUI();
  initReminders();
  renderBadges();
  renderYearHistory();
  updateNotifStatusBar();
}
function unlockNav() {
  ['input','history','share'].forEach(id => {
    const navEl = el('nav-' + id);
    if (navEl) navEl.classList.remove('locked');
  });
  el('fabBtn').style.display = 'flex';
}

// v1.5: improved navGuard with tooltip
function navGuard(section) {
  if (!S.modeSet) {
    showLockedHint();
    return;
  }
  showSection(section);
}

function showLockedHint() {
  const hint = el('lockedNavHint');
  if (!hint) return;
  hint.style.display = 'flex';
  clearTimeout(_lockedHintTimer);
  _lockedHintTimer = setTimeout(() => { hint.style.display = 'none'; }, 3500);
}
function goToSetup() {
  el('lockedNavHint').style.display = 'none';
  el('welcomeScreen').style.display = 'flex';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showSection(id) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const sec = el('section-' + id);
  const nav = el('nav-' + id);
  if (sec) sec.classList.add('active');
  if (nav) nav.classList.add('active');

  if (id === 'input') {
    setActiveInputDate(localDate());
    updateInputSection();
  }
  if (id === 'history') { renderHistory(); renderChart(); renderYearHistory(); }
  if (id === 'share') renderShareCanvas();
  if (id === 'settings') renderSettings();
}

// ‚îÄ‚îÄ‚îÄ Progressive Disclosure (v1.5) ‚îÄ‚îÄ‚îÄ
function toggleHomeDetails() {
  _homeDetailsOpen = !_homeDetailsOpen;
  const details = el('homeDetails');
  const btn = el('homeToggleBtn');
  if (details) {
    details.classList.toggle('expanded', _homeDetailsOpen);
  }
  if (btn) {
    btn.classList.toggle('open', _homeDetailsOpen);
    btn.setAttribute('aria-expanded', _homeDetailsOpen);
    const label = btn.querySelector('span:first-child');
    if (label) label.textContent = _homeDetailsOpen ? 'üìä Sembunyikan Statistik' : 'üìä Lihat Statistik Lengkap';
  }
  if (_homeDetailsOpen) {
    updateInsights();
    renderStreakBar();
    renderPrayerBreakdown();
    renderBadges();
    renderPrayerPie();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MASTER UI UPDATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateAllUI() {
  updateHeader();
  updateHomeSection();
  updateInputSection();
  if (_homeDetailsOpen) {
    updateInsights();
    renderStreakBar();
    renderPrayerBreakdown();
    renderBadges();
    renderPrayerPie();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HEADER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateHeader() {
  const elDate = el('headerDate');
  if (!elDate) return;

  const today = new Date();
  elDate.textContent = today.toLocaleDateString('id-ID', {weekday:'short', day:'numeric', month:'short'});
  setText('headerRamDay', S.modeSet ? `Hari ke-${getRamadhanDay()} ${getRamLabel()}` : getRamLabel());
  setText('mainTitle', `Tilawah ${getRamLabel()}`);
  setText('mainSubtitle', S.modeSet ? S.userName : '');

  if (!S.modeSet) return;

  const todayStr = localDate();
  const todayPages = getTodayPages(todayStr);
  const pct = Math.min(100, Math.round((todayPages / S.dailyTarget) * 100));
  setText('headerTodayVal', `${todayPages} / ${S.dailyTarget} halaman`);

  const elPct = el('headerTodayPct');
  if (elPct) {
    elPct.textContent = pct + '%';
    elPct.style.color = pct >= 100 ? 'var(--green)' : pct >= 70 ? 'var(--blue)' : 'var(--amber)';
  }
  const elBar = el('headerMiniBar');
  if (elBar) {
    elBar.style.width = pct + '%';
    elBar.className = 'today-mini-fill ' + getStatusClass(todayPages, S.dailyTarget);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HOME SECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateHomeSection() {
  if (!S.modeSet) return;
  const daysGone = getDaysGone();
  const expectedSoFar = daysGone * S.dailyTarget;
  const onTrackPct = expectedSoFar > 0 ? Math.min(150, (S.totalRead / expectedSoFar) * 100) : 0;
  const overallPct = S.totalTarget > 0 ? Math.min(100, (S.totalRead / S.totalTarget) * 100) : 0;
  const ringPct = expectedSoFar > 0 ? Math.min(100, onTrackPct) : overallPct;
  const ringDisplay = expectedSoFar > 0 ? Math.min(100, Math.round(onTrackPct)) : Math.round(overallPct);

  const circum = 395.84;
  const ring = el('progressRingCircle');
  if (ring) {
    ring.style.strokeDashoffset = circum - (ringPct/100) * circum;
    const g1 = el('pgG1'), g2 = el('pgG2');
    if (onTrackPct >= 100) { if(g1) g1.setAttribute('stop-color','#3dd68c'); if(g2) g2.setAttribute('stop-color','#4ade80'); }
    else if (onTrackPct >= 80) { if(g1) g1.setAttribute('stop-color','#4a90e8'); if(g2) g2.setAttribute('stop-color','#60a5fa'); }
    else { if(g1) g1.setAttribute('stop-color','#f0a030'); if(g2) g2.setAttribute('stop-color','#fbbf24'); }
  }
  setText('progressPct', ringDisplay + '%');
  if (overallPct >= 100) setText('progressSub', 'Khatam! üéâ');
  else if (daysGone <= 0) setText('progressSub', 'Belum mulai');
  else setText('progressSub', Math.round(overallPct) + '% total target');
  setText('khatamBadge', `${S.currentKhatam}√ó Khatam`);

  setText('totalRead', S.totalRead);
  setText('totalReadJuz', (S.totalRead / (PAGES_PER_KHATAM/30)).toFixed(1) + ' Juz');
  const rem = Math.max(0, S.totalTarget - S.totalRead);
  setText('remaining', rem);
  setText('remainingJuz', (rem / (PAGES_PER_KHATAM/30)).toFixed(1) + ' Juz');

  const avgD = daysGone > 0 ? (S.totalRead / daysGone) : 0;
  setText('avgDaily', Math.round(avgD));

  // Projection
  const daysLeft = getDaysLeft();
  if (rem <= 0) {
    setText('projDate', '‚úÖ');
  } else if (avgD > 0) {
    const daysNeeded = Math.ceil(rem / avgD);
    const ramEndDate = new Date(S.startDate + 'T00:00:00');
    ramEndDate.setDate(ramEndDate.getDate() + DAYS_RAMADHAN - 1);
    const projDate = new Date();
    projDate.setDate(projDate.getDate() + daysNeeded);
    if (!((projDate > ramEndDate) && daysNeeded > daysLeft + 3)) {
      setText('projDate', projDate.toLocaleDateString('id-ID', {day:'numeric',month:'short'}));
    } else if (daysLeft > 0) {
      setText('projDate', Math.ceil(rem / daysLeft) + '/hr');
    } else {
      setText('projDate', '‚Äî');
    }
  } else {
    setText('projDate', '‚Äî');
  }

  updateStatusBanner();
}

function updateStatusBanner() {
  const todayStr = localDate();
  const todayPages = getTodayPages(todayStr);
  const daysGone = getDaysGone();
  const shouldHaveRead = daysGone * S.dailyTarget;
  const diff = S.totalRead - shouldHaveRead;

  const banner = el('statusBanner');
  const icon = el('statusIcon');
  const title = el('statusTitle');
  const msg = el('statusMsg');
  const action = el('statusAction');
  if (!banner) return;
  setText('statusTarget', S.dailyTarget);
  action.innerHTML = '';

  if (todayPages >= S.dailyTarget) {
    banner.className = 'status-banner ahead';
    icon.textContent = 'üåü';
    title.textContent = 'MasyaAllah! Target hari ini tercapai!';
    msg.innerHTML = diff >= 0
      ? `Kamu <strong style="color:var(--green);">${Math.abs(diff)} halaman</strong> di atas total target. Luar biasa!`
      : 'Hari ini on-track! Pertahankan konsistensi ini.';
  } else if (diff < -S.dailyTarget * 1.5) {
    banner.className = 'status-banner behind';
    icon.textContent = '‚ö°';
    title.textContent = 'Yuk, kita kejar!';
    const daysLeft = getDaysLeft();
    const extraPerDay = daysLeft > 0 ? Math.ceil(Math.abs(diff) / daysLeft) : 0;
    msg.innerHTML = `Kamu tertinggal <strong style="color:var(--amber);">${Math.abs(diff)} halaman</strong>. Tambah <strong>${extraPerDay} halaman/hari</strong> untuk ${daysLeft} hari ke depan.`;
    action.innerHTML = `<button class="btn btn-amber btn-sm btn-auto" onclick="showSection('settings');setTimeout(()=>el('calcDays')?.focus(),200);">üèÉ Hitung Kejar Setoran</button>`;
  } else if (diff < 0) {
    banner.className = 'status-banner behind';
    icon.textContent = 'üìñ';
    title.textContent = 'Sedikit lagi!';
    const todayLeft = Math.max(0, S.dailyTarget - todayPages);
    msg.innerHTML = `Tambah <strong style="color:var(--amber);">${todayLeft} halaman</strong> lagi hari ini untuk kembali on-track.`;
  } else {
    banner.className = 'status-banner on-track';
    icon.textContent = '‚ú®';
    title.textContent = 'Alhamdulillah, on-track!';
    msg.innerHTML = `Kamu sudah baca <strong>${todayPages}</strong> halaman hari ini. Target: ${S.dailyTarget}.`;
  }
}

// ‚îÄ‚îÄ‚îÄ v1.5: Streak bar (larger dots, no label inside) ‚îÄ‚îÄ‚îÄ
function renderStreakBar() {
  const bar = el('streakBar');
  if (!bar) return;
  const todayStr = localDate();

  // Unified streak logic ‚Äî counts consecutive days AT OR ABOVE target
  let maxStreak = getStreakCount('above');
  let dots = '';
  for (let i = 0; i < DAYS_RAMADHAN; i++) {
    const d = new Date(S.startDate + 'T00:00:00');
    d.setDate(d.getDate() + i);
    const ds = d.toLocaleDateString('en-CA');
    const pages = getTodayPages(ds);
    const isFuture = ds > todayStr;
    const isToday = ds === todayStr;
    let cls;
    if (isFuture) { cls = 'empty'; }
    else if (pages >= S.dailyTarget) { cls = 'over'; }
    else if (pages > 0) { cls = 'on'; }
    else if (isToday) { cls = 'today'; }
    else { cls = 'miss'; }
    dots += `<div class="streak-dot-wrap" title="Hari ${i+1}: ${pages} hal">
      <div class="s-dot ${cls}"></div>
    </div>`;
  }
  bar.innerHTML = dots;
  setText('streakBadge', `${maxStreak} hari üî•`);
  setText('streakInfo', maxStreak > 0 ? `${maxStreak} hari berturut-turut di atas target üéØ` : 'Mulai streak hari ini!');
}

function renderPrayerBreakdown() {
  const container = el('prayerBreakdown');
  if (!container) return;
  const allLogs = Object.values(S.dailyLogs).flat();
  container.innerHTML = PRAYERS.map(p => {
    const target = S.breakdown[p.name] || 0;
    const actual = allLogs.filter(l => l.prayer === p.name).reduce((s,l) => s+l.pages, 0);
    const color = actual > 0 ? 'var(--blue)' : 'var(--text3)';
    return `<div class="prayer-item">
      <span class="prayer-emoji">${p.emoji}</span>
      <div class="prayer-name">${p.name}</div>
      <div class="prayer-pages">${target}<span> hal</span></div>
      <div style="font-size:0.62rem;color:${color};margin-top:2px;">${actual} total</div>
    </div>`;
  }).join('');
  const noteEl = el('breakdownModeNote');
  if (noteEl) {
    if (S.customBreakdown) {
      noteEl.innerHTML = '‚öôÔ∏è <span style="color:var(--amber);">Target diubah manual</span> ¬∑ <button onclick="resetBreakdownToAuto()" style="background:none;border:none;color:var(--gold);font-size:0.66rem;cursor:pointer;text-decoration:underline;padding:0;font-family:var(--font-body);">Reset ke otomatis</button>';
    } else {
      noteEl.textContent = 'Otomatis dihitung berdasarkan bobot waktu';
      noteEl.style.color = 'var(--text3)';
    }
  }
}

function updateInsights() {
  const insightEl = el('insightContent');
  if (!insightEl) return;
  const dates = Object.keys(S.dailyLogs).sort();
  if (dates.length < 2) {
    insightEl.innerHTML = '<div class="empty-state"><span class="empty-icon">üìä</span>Insight tersedia setelah beberapa hari input data</div>';
    return;
  }
  const prayerTotals = {};
  Object.values(S.dailyLogs).flat().forEach(l => { prayerTotals[l.prayer] = (prayerTotals[l.prayer]||0) + l.pages; });
  const bestPrayer = Object.entries(prayerTotals).sort((a,b)=>b[1]-a[1])[0];
  const dayTotals = {};
  Object.entries(S.dailyLogs).forEach(([d,logs]) => {
    const day = new Date(d+'T00:00:00').toLocaleDateString('id-ID',{weekday:'long'});
    dayTotals[day] = (dayTotals[day]||0) + logs.reduce((s,l)=>s+l.pages,0);
  });
  const bestDay = Object.entries(dayTotals).sort((a,b)=>b[1]-a[1])[0];
  const daysGone = getDaysGone();
  const avgD = daysGone > 0 ? Math.round(S.totalRead / daysGone) : 0;
  const daysLeft = getDaysLeft();
  const rem = Math.max(0, S.totalTarget - S.totalRead);

  let html = '';
  if (bestPrayer) html += `<div class="insight-row"><span class="insight-icon">‚≠ê</span><span class="insight-text">Waktu terbanyak membaca: <strong>${bestPrayer[0]}</strong> (${bestPrayer[1]} hal)</span></div>`;
  if (bestDay) html += `<div class="insight-row"><span class="insight-icon">üìÖ</span><span class="insight-text">Hari terkonsisten: <strong>${bestDay[0]}</strong></span></div>`;
  html += `<div class="insight-row"><span class="insight-icon">üìà</span><span class="insight-text">Rata-rata: <strong>${avgD} hal/hari</strong> (target: ${S.dailyTarget})</span></div>`;
  if (rem > 0 && daysLeft > 0) {
    const neededPerDay = Math.ceil(rem / daysLeft);
    html += `<div class="insight-row"><span class="insight-icon">üèÅ</span><span class="insight-text">Perlu <strong>${neededPerDay} hal/hari</strong> untuk ${daysLeft} hari ke depan agar khatam dalam Ramadhan.</span></div>`;
  }
  insightEl.innerHTML = html || '<div class="empty-state">Terus mencatat untuk mendapatkan insight lebih dalam! üìñ</div>';
}

// ‚îÄ‚îÄ‚îÄ v1.5: Prayer Pie Chart ‚îÄ‚îÄ‚îÄ
function renderPrayerPie() {
  const allLogs = Object.values(S.dailyLogs).flat();
  const prayerTotals = {};
  allLogs.forEach(l => { prayerTotals[l.prayer] = (prayerTotals[l.prayer]||0) + l.pages; });
  const total = Object.values(prayerTotals).reduce((a,b)=>a+b, 0);

  const card = el('prayerPieCard');
  const canvas = el('pieCanvas');
  const legend = el('pieLegend');
  if (!canvas || !legend || total === 0) { if(card) card.style.display = 'none'; return; }
  if (card) card.style.display = '';

  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, 120, 120);
  let startAngle = -Math.PI / 2;
  PRAYERS.forEach(p => {
    const pages = prayerTotals[p.name] || 0;
    if (pages === 0) return;
    const slice = (pages / total) * 2 * Math.PI;
    ctx.beginPath();
    ctx.moveTo(60, 60);
    ctx.arc(60, 60, 55, startAngle, startAngle + slice);
    ctx.closePath();
    ctx.fillStyle = PRAYER_COLORS[p.name] || '#888';
    ctx.fill();
    startAngle += slice;
  });

  legend.innerHTML = PRAYERS.map(p => {
    const pages = prayerTotals[p.name] || 0;
    if (pages === 0) return '';
    const pct = Math.round((pages / total) * 100);
    return `<div class="pie-legend-row">
      <div class="pie-dot" style="background:${PRAYER_COLORS[p.name]};"></div>
      <span>${p.emoji} ${p.name}</span>
      <span style="margin-left:auto;font-weight:700;color:var(--text);">${pct}%</span>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INPUT SECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateInputSection() {
  if (!S.modeSet) return;
  const dateStr = getActiveInputDate();
  const todayPages = getTodayPages(dateStr);
  const remain = Math.max(0, S.dailyTarget - todayPages);
  const pct = Math.min(100, Math.round((todayPages / S.dailyTarget) * 100));
  const isToday = dateStr === localDate();

  const cardTitle = el('inputCardTitle');
  if (cardTitle) {
    cardTitle.textContent = isToday ? 'Hari Ini' : new Date(dateStr + 'T00:00:00').toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'short'});
  }

  setText('inputTodayTotal', todayPages);
  setText('inputDailyTarget', S.dailyTarget);
  setText('inputTodayRemain', remain);

  const barEl = el('inputTodayBar');
  if (barEl) {
    barEl.style.width = pct + '%';
    barEl.className = 'prog-bar-fill ' + getStatusClass(todayPages, S.dailyTarget);
  }

  // v1.5: smart prayer suggestion
  applySuggestedPrayer();

  renderTodayLog(dateStr);
  updatePrayerHint();
  checkBackfillBanner();
}

function applySuggestedPrayer() {
  const suggested = getSuggestedPrayer();
  const badge = el('smartSuggestionBadge');
  const selectEl = el('prayerSelect');
  if (selectEl && badge) {
    selectEl.value = suggested;
    badge.style.display = 'inline-block';
    badge.textContent = `Saran: ${suggested}`;
  }
}

function updatePrayerHint() {
  const prayer = el('prayerSelect')?.value;
  const hint = el('prayerHint');
  if (!hint || !prayer) return;
  const target = S.breakdown[prayer] || 0;
  hint.textContent = target > 0 ? `Target ${prayer}: ${target} halaman` : '';
}

function renderTodayLog(dateStr) {
  const logEl = el('todayLog');
  if (!logEl) return;
  const logs = S.dailyLogs[dateStr] || [];
  const total = logs.reduce((s,l) => s + l.pages, 0);
  setText('todayTotalBottom', total + ' Halaman');

  const logCardTitle = el('logCardTitle');
  if (logCardTitle) {
    logCardTitle.textContent = dateStr === localDate() ? 'Log Hari Ini' : `Log: ${dateStr}`;
  }

  if (!logs.length) {
    logEl.innerHTML = `<div class="empty-state"><span class="empty-icon">üìñ</span>Belum ada tilawah${dateStr === localDate() ? ' hari ini' : ' di tanggal ini'}</div>`;
    return;
  }
  logEl.innerHTML = logs.slice().reverse().map(l => {
    const pEmoji = PRAYERS.find(p=>p.name===l.prayer)?.emoji || 'üìñ';
    return `<div class="log-entry" id="log-${l.id}">
      <span class="log-icon">${pEmoji}</span>
      <div class="log-main">
        <div class="log-prayer">${l.prayer}</div>
        ${l.pos ? `<div class="log-pos">${l.pos}</div>` : ''}
      </div>
      <div class="log-right">
        <span class="log-pages">+${l.pages} hal</span>
        <span class="log-time">${l.time||''}</span>
        <button class="log-del" onclick="confirmDeleteLog('${dateStr}',${l.id})" title="Hapus log ini" aria-label="Hapus catatan ini">üóë</button>
      </div>
    </div>`;
  }).join('');
}

function onLogDateChange() {
  const logDateEl = el('logDate');
  if (logDateEl?.value) setActiveInputDate(logDateEl.value);
  updateInputSection();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADD LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addLog() {
  const date = getActiveInputDate();
  const prayer = el('prayerSelect')?.value;
  const pages = parseInt(el('pagesInput')?.value) || 0;
  const pos = el('lastPosInput')?.value.trim() || '';
  if (!prayer) { showToast('‚ö†Ô∏è Pilih waktu sholat!'); return; }
  if (pages < 1) { showToast('‚ö†Ô∏è Masukkan jumlah halaman!'); return; }
  doAddLog(date, prayer, pages, pos);
  if (el('pagesInput')) el('pagesInput').value = '';
  if (el('lastPosInput')) el('lastPosInput').value = '';
  if (el('pagesInput')) el('pagesInput').focus();
}

function addLogFromSheet() {
  // v1.5: use sheetDate instead of hardcoded today
  const sheetDateEl = el('sheetDate');
  const date = sheetDateEl?.value || localDate();
  const prayer = el('sheetPrayer')?.value;
  const pages = parseInt(el('sheetPages')?.value) || 0;
  const pos = el('sheetPos')?.value.trim() || '';
  if (pages < 1) { showToast('‚ö†Ô∏è Masukkan jumlah halaman dulu!'); return; }

  _lastSheetPrayer = prayer; // remember for next time

  const saveBtn = document.querySelector('#inputSheet .btn-primary');
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.textContent = '‚úÖ Tersimpan!';
    saveBtn.style.background = 'var(--green)';
  }
  doAddLog(date, prayer, pages, pos);
  if (el('sheetPages')) el('sheetPages').value = '';
  if (el('sheetPos')) el('sheetPos').value = '';
  setTimeout(() => closeInputSheet(), 900);
}

function doAddLog(date, prayer, pages, pos) {
  if (!S.dailyLogs[date]) S.dailyLogs[date] = [];
  S.dailyLogs[date].push({
    id: Date.now(), prayer, pages, pos,
    time: new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})
  });
  S.totalRead = Object.values(S.dailyLogs).flat().reduce((s,l) => s + l.pages, 0);
  const prevKhatam = S.currentKhatam;
  S.currentKhatam = Math.floor(S.totalRead / PAGES_PER_KHATAM);
  checkBadges();
  save();
  _shareCanvasDirty = true;
  updateAllUI();
  showCheckAnim();
  showToast(`‚úÖ +${pages} halaman (${prayer}) tersimpan!`);
  if (S.currentKhatam > prevKhatam) showCelebration(S.currentKhatam);
}

function quickInput(n) {
  const inp = el('pagesInput');
  if (!inp) return;
  inp.value = n;
  inp.style.transition = 'background 0.2s';
  inp.style.background = 'rgba(61,214,140,0.18)';
  setTimeout(() => { inp.style.background = ''; }, 500);
}
function sheetQuickInput(n) {
  const inp = el('sheetPages');
  if (!inp) return;
  inp.value = n;
  inp.style.transition = 'background 0.2s';
  inp.style.background = 'rgba(61,214,140,0.18)';
  setTimeout(() => { inp.style.background = ''; }, 500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DELETE LOG (BUG-005: inline confirm without new Function)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function confirmDeleteLog(date, id) {
  const entry = el('log-' + id);
  const delBtn = entry?.querySelector('.log-del');
  if (!delBtn) { deleteLog(date, id); return; }
  if (delBtn.dataset.confirming === '1') {
    deleteLog(date, id);
    return;
  }
  delBtn.dataset.confirming = '1';
  delBtn.textContent = 'Yakin?';
  delBtn.style.color = 'var(--red)';
  delBtn.style.background = 'var(--red-dim)';
  delBtn.style.padding = '3px 7px';
  delBtn.style.border = '1px solid rgba(232,84,84,0.4)';
  delBtn.style.borderRadius = '6px';
  delBtn.style.fontSize = '0.72rem';
  setTimeout(() => {
    if (delBtn.dataset.confirming === '1') {
      delBtn.dataset.confirming = '0';
      delBtn.textContent = 'üóë';
      delBtn.style.cssText = '';
    }
  }, 3000);
}

function deleteLog(date, id) {
  if (!S.dailyLogs[date]) return;
  S.dailyLogs[date] = S.dailyLogs[date].filter(l => l.id !== id);
  if (!S.dailyLogs[date].length) delete S.dailyLogs[date];
  S.totalRead = Object.values(S.dailyLogs).flat().reduce((s,l) => s + l.pages, 0);
  S.currentKhatam = Math.floor(S.totalRead / PAGES_PER_KHATAM);
  save();
  _shareCanvasDirty = true;
  updateAllUI();
  showToast('üóëÔ∏è Log dihapus');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHistory() {
  renderWeekly();
  renderTrendChart();
  populateHistorySelect();
}
function renderWeekly() {
  const container = el('weeklySummary');
  if (!container) return;
  const weeks = [];
  for (let w = 0; w < 5; w++) {
    const days = [];
    for (let d = 0; d < 7; d++) {
      const idx = w*7 + d;
      if (idx >= DAYS_RAMADHAN) break;
      const dt = new Date(S.startDate + 'T00:00:00');
      dt.setDate(dt.getDate() + idx);
      const ds = dt.toLocaleDateString('en-CA');
      days.push({ds, pages: getTodayPages(ds), day: idx+1});
    }
    if (days.length) weeks.push(days);
  }
  if (!weeks.some(w => w.some(d => d.pages > 0))) {
    container.innerHTML = '<div class="empty-state">Belum ada data</div>'; return;
  }
  container.innerHTML = weeks.map((wdays, wi) => {
    const total = wdays.reduce((s,d)=>s+d.pages,0);
    const weekTarget = wdays.length * S.dailyTarget;
    const cls = total >= weekTarget ? 'ahead' : total > 0 ? 'on-track' : 'behind';
    return `<div class="week-card">
      <div class="week-header">
        <span class="week-label">Minggu ${wi+1} (Hari ${wdays[0].day}‚Äì${wdays[wdays.length-1].day})</span>
        <span class="week-total">${total} / ${weekTarget} hal</span>
      </div>
      <div class="prog-bar-wrap"><div class="prog-bar-fill ${cls}" style="width:${Math.min(100,(total/weekTarget)*100)}%"></div></div>
    </div>`;
  }).join('');
}
function renderChart() {
  const container = el('dailyChart');
  if (!container) return;
  let maxPages = S.dailyTarget;
  const bars = [];
  for (let i = 0; i < DAYS_RAMADHAN; i++) {
    const dt = new Date(S.startDate + 'T00:00:00');
    dt.setDate(dt.getDate() + i);
    const ds = dt.toLocaleDateString('en-CA');
    const pages = getTodayPages(ds);
    bars.push({ds, pages, day: i+1});
    if (pages > maxPages) maxPages = pages;
  }
  container.innerHTML = bars.map(b => {
    const pct = maxPages > 0 ? (b.pages / maxPages) * 100 : 0;
    const cls = b.pages >= S.dailyTarget ? 'ahead' : b.pages > 0 ? 'on-track' : 'behind';
    return `<div class="bar-col" onclick="selectHistoryDate('${b.ds}')">
      <div class="bar-fill ${cls}" style="height:${pct}%;${b.pages===0?'opacity:0.2;':''}"></div>
      <div class="bar-lbl">${b.day}</div>
    </div>`;
  }).join('');
}
function populateHistorySelect() {
  const sel = el('historyDateSelect');
  if (!sel) return;
  const dates = Object.keys(S.dailyLogs).sort().reverse();
  sel.innerHTML = dates.length
    ? dates.map(d => `<option value="${d}">${d} (${getTodayPages(d)} hal)</option>`).join('')
    : '<option value="">Belum ada data</option>';
  if (dates.length) renderHistoryDetail();
}
function selectHistoryDate(ds) {
  const sel = el('historyDateSelect');
  if (sel) { sel.value = ds; renderHistoryDetail(); }
  showSection('history');
}
function navHistory(dir) {
  const sel = el('historyDateSelect');
  if (!sel || !sel.options.length) return;
  const next = sel.selectedIndex - dir;
  if (next >= 0 && next < sel.options.length) { sel.selectedIndex = next; renderHistoryDetail(); }
}
function renderHistoryDetail() {
  const sel = el('historyDateSelect');
  const detailEl = el('historyDetail');
  if (!sel?.value || !detailEl) return;
  const ds = sel.value;
  const logs = S.dailyLogs[ds] || [];
  const total = logs.reduce((s,l)=>s+l.pages, 0);
  if (!logs.length) { detailEl.innerHTML = '<div class="empty-state">Tidak ada log</div>'; return; }
  detailEl.innerHTML = `<div class="history-day-header"><span>${ds}</span><span class="history-day-total">${total} halaman</span></div>` +
    logs.map(l => {
      const pEmoji = PRAYERS.find(p=>p.name===l.prayer)?.emoji || 'üìñ';
      return `<div class="log-entry">
        <span class="log-icon">${pEmoji}</span>
        <div class="log-main"><div class="log-prayer">${l.prayer}</div>${l.pos?`<div class="log-pos">${l.pos}</div>`:''}</div>
        <div class="log-right"><span class="log-pages">+${l.pages} hal</span><span class="log-time">${l.time||''}</span></div>
      </div>`;
    }).join('');
}
function renderYearHistory() {
  const container = el('yearHistory');
  if (!container) return;
  const currentYear = {year: getRamLabel(), khatam: S.currentKhatam, read: S.totalRead, target: S.khatamTarget};
  const all = [currentYear, ...(S.yearHistory||[]).filter(y => y.year !== currentYear.year)];
  if (all.length === 0 || (all.length === 1 && all[0].khatam === 0 && all[0].read === 0)) {
    container.innerHTML = '<div class="insight-row"><span class="insight-icon">üåô</span><span class="insight-text">Riwayat Ramadhan dari tahun-tahun sebelumnya akan tampil di sini.</span></div>';
    return;
  }
  container.innerHTML = all.map(y => `
    <div class="year-card">
      <span class="year-icon">${y.khatam >= y.target ? 'üèÜ' : 'üìñ'}</span>
      <div class="year-info">
        <div class="year-label">${y.year}</div>
        <div class="year-data">${y.read} halaman ‚Ä¢ ${y.khatam}√ó khatam dari target ${y.target}√ó</div>
      </div>
    </div>`).join('');
}

// ‚îÄ‚îÄ‚îÄ Trend Chart ‚îÄ‚îÄ‚îÄ
function renderTrendChart() {
  const colsEl = el('trendCols');
  const legendEl = el('trendLegend');
  const targetLineEl = el('trendTargetLine');
  if (!colsEl) return;

  const weeks = [];
  for (let w = 0; w < 5; w++) {
    let total = 0, totalDays = 0;
    for (let d = 0; d < 7; d++) {
      const idx = w*7+d;
      if (idx >= DAYS_RAMADHAN) break;
      const dt = new Date(S.startDate+'T00:00:00');
      dt.setDate(dt.getDate() + idx);
      const ds = dt.toLocaleDateString('en-CA');
      total += getTodayPages(ds);
      totalDays++;
    }
    if (totalDays > 0) weeks.push({ label:`Mg ${w+1}`, avg: totalDays>0 ? Math.round(total/totalDays) : 0 });
  }

  const hasData = weeks.some(w => w.avg > 0);
  if (!hasData) {
    colsEl.innerHTML = '<div class="empty-state" style="height:100px;padding:24px 0;">Belum ada data minggu ini</div>';
    if (legendEl) legendEl.innerHTML = '';
    if (targetLineEl) targetLineEl.style.display = 'none';
    return;
  }

  const maxAvg = Math.max(...weeks.map(w=>w.avg), S.dailyTarget, 1);
  const CHART_H = 100;

  colsEl.innerHTML = weeks.map((w, i) => {
    const barH = Math.max(4, Math.round((w.avg/maxAvg)*CHART_H));
    const prev = i > 0 ? weeks[i-1].avg : null;
    let cls = 'flat';
    if (!w.avg) cls = 'empty';
    else if (prev !== null) {
      if (w.avg > prev*1.05) cls = 'up';
      else if (w.avg < prev*0.95) cls = 'down';
    }
    const arrow = cls==='up'?' ‚Üë':cls==='down'?' ‚Üì':'';
    return `<div class="trend-col">
      <div class="trend-lbl-top">${w.avg>0?w.avg+arrow:'‚Äî'}</div>
      <div class="trend-bar ${cls}" style="height:${w.avg>0?barH:4}px;"></div>
      <div class="trend-lbl-bottom">${w.label}</div>
    </div>`;
  }).join('');

  if (targetLineEl && maxAvg > 0) {
    const targetH = Math.round((S.dailyTarget/maxAvg)*CHART_H);
    targetLineEl.style.display = '';
    targetLineEl.style.bottom = (targetH + 18) + 'px';
  }

  if (legendEl) {
    const valid = weeks.filter(w=>w.avg>0);
    const avg = valid.length > 0 ? Math.round(valid.reduce((s,w)=>s+w.avg,0)/valid.length) : 0;
    legendEl.innerHTML =
      `<span><span class="tl-dot" style="background:var(--green);"></span>Naik</span>
       <span><span class="tl-dot" style="background:var(--red);"></span>Turun</span>
       <span><span class="tl-dot" style="background:var(--blue);"></span>Stabil</span>
       <span style="color:var(--text2);">Rata-rata: <strong style="color:var(--text);">${avg} hal/hari</strong> ¬∑ Target: ${S.dailyTarget}</span>`;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BADGES (BUG-003 fix: unified streak)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkBadges() {
  const totalLogs = Object.values(S.dailyLogs).flat().length;
  const earned = [...(S.earnedBadges||[])];
  if (totalLogs >= 1 && !earned.includes('first_log')) earned.push('first_log');
  if (S.currentKhatam >= 1 && !earned.includes('first_khatam')) earned.push('first_khatam');
  if (S.totalRead >= S.totalTarget * 0.5 && !earned.includes('half_khatam')) earned.push('half_khatam');

  // Unified streak using helper
  const streak = getStreakCount('above');
  if (streak >= 3 && !earned.includes('streak3')) earned.push('streak3');
  if (streak >= 7 && !earned.includes('streak7')) earned.push('streak7');

  // On-track badge
  const todayStr = localDate();
  let onTrack = 0;
  for (let i = 0; i < DAYS_RAMADHAN; i++) {
    const dt = new Date(S.startDate + 'T00:00:00');
    dt.setDate(dt.getDate() + i);
    const ds = dt.toLocaleDateString('en-CA');
    if (ds > todayStr) break;
    if (getTodayPages(ds) >= S.dailyTarget * 0.9) onTrack++;
  }
  if (onTrack >= 5 && !earned.includes('on_track_5')) earned.push('on_track_5');

  const newBadges = earned.filter(b => !(S.earnedBadges||[]).includes(b));
  S.earnedBadges = earned;
  if (newBadges.length) {
    const badge = BADGES.find(b => b.id === newBadges[0]);
    if (badge) showToast(`üèÖ Badge baru: ${badge.emoji} ${badge.name}!`);
  }
}

// v1.5: Badges show criteria on tap
function renderBadges() {
  const container = el('badgeGrid');
  if (!container) return;
  container.innerHTML = BADGES.map(b => {
    const earned = (S.earnedBadges||[]).includes(b.id);
    return `<div class="badge-item ${earned?'earned':'locked-badge'}" onclick="showBadgeInfo('${b.id}')">
      <span class="badge-emoji">${b.emoji}</span>
      <div class="badge-name">${b.name}</div>
      <div class="badge-desc">${b.desc}</div>
    </div>`;
  }).join('');
}

function showBadgeInfo(id) {
  const badge = BADGES.find(b => b.id === id);
  if (!badge) return;
  const earned = (S.earnedBadges||[]).includes(id);
  showModal(
    `${badge.emoji} ${badge.name}`,
    `<div style="text-align:center;line-height:1.8;font-size:0.86rem;">
      <div style="font-size:3rem;margin-bottom:8px;">${badge.emoji}</div>
      <div style="color:var(--text2);">${badge.desc}</div>
      <div style="margin-top:12px;padding:10px;background:var(--surface2);border-radius:8px;">
        <div style="font-size:0.72rem;color:var(--text3);margin-bottom:4px;">SYARAT</div>
        <div style="color:var(--text);font-weight:600;">${badge.criterion}</div>
      </div>
      <div style="margin-top:10px;font-size:0.84rem;color:${earned?'var(--green)':'var(--amber)'};">
        ${earned ? '‚úÖ Sudah diraih!' : 'üîí Belum diraih'}
      </div>
    </div>`,
    'Tutup', closeModal, null, null
  );
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CELEBRATION (BUG-011: auto close)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showCelebration(n) {
  const overlay = document.createElement('div');
  overlay.id = 'celebrationOverlay';
  const colors = ['#e8b84b','#3dd68c','#4a90e8','#f0a030','#fff'];
  let confetti = '';
  for (let i = 0; i < 40; i++) {
    const x = Math.random()*100, delay = Math.random()*2, dur = 2+Math.random()*2;
    const color = colors[Math.floor(Math.random()*colors.length)];
    confetti += `<div class="confetti-dot" style="left:${x}%;background:${color};animation-duration:${dur}s;animation-delay:${delay}s;"></div>`;
  }
  overlay.innerHTML = confetti + `
    <div class="celebration-content">
      <span class="celebration-emoji">üèÜ</span>
      <h2 class="celebration-title">Khatam ke-${n}!</h2>
      <p style="color:var(--text2);font-size:0.9rem;margin-bottom:20px;">Alhamdulillah! Kamu telah menyelesaikan<br>${n}√ó khatam Al-Qur'an di Ramadhan ini!</p>
      <button class="btn btn-primary" style="width:auto;padding:12px 32px;" onclick="closeCelebration()">‚ú® Syukur, Lanjutkan!</button>
    </div>`;
  document.body.appendChild(overlay);
  showToast(`üéâ MasyaAllah! Khatam ke-${n}!`);
  // v1.5: auto-close after 12 seconds
  setTimeout(() => { if (el('celebrationOverlay')) closeCelebration(); }, 12000);
}
function closeCelebration() { el('celebrationOverlay')?.remove(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INPUT SHEET (FAB) ‚Äî v1.5: with date picker
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openInputSheet() {
  if (el('sheetPages')) el('sheetPages').value = '';
  if (el('sheetPos')) el('sheetPos').value = '';

  // v1.5: set date picker to activeInputDate
  const sheetDateEl = el('sheetDate');
  if (sheetDateEl) sheetDateEl.value = getActiveInputDate();

  // v1.5: smart prayer suggestion
  const suggested = getSuggestedPrayer();
  const prayerEl = el('sheetPrayer');
  if (prayerEl) {
    prayerEl.value = suggested;
    const badge = el('sheetSuggestBadge');
    if (badge) { badge.style.display = 'inline-block'; badge.textContent = `Otomatis: ${suggested}`; }
  }

  // Reset save button
  const saveBtn = document.querySelector('#inputSheet .btn-primary');
  if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = '+ Simpan Tilawah'; saveBtn.style.background = ''; }
  el('inputSheet').style.display = 'flex';
  if (el('sheetPages')) el('sheetPages').focus();
}
function closeInputSheet() {
  el('inputSheet').style.display = 'none';
  const saveBtn = document.querySelector('#inputSheet .btn-primary');
  if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = '+ Simpan Tilawah'; saveBtn.style.background = ''; }
}
function closeSheetBg(e) { if (e.target === el('inputSheet')) closeInputSheet(); }

function onSheetDateChange() {
  const sheetDateEl = el('sheetDate');
  if (sheetDateEl?.value) setActiveInputDate(sheetDateEl.value);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SHARE CANVAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderShareCanvas() {
  const canvas = el('shareCanvas');
  if (!canvas || !S.modeSet) return;
  if (!_shareCanvasDirty) return;
  _shareCanvasDirty = false;
  const ctx = canvas.getContext('2d');
  const W = 700, H = 440;
  ctx.fillStyle = '#0a0e1a';
  ctx.fillRect(0,0,W,H);
  const grad = ctx.createLinearGradient(0,0,W,0);
  grad.addColorStop(0,'transparent'); grad.addColorStop(0.3,'#e8b84b');
  grad.addColorStop(0.7,'#4a90e8'); grad.addColorStop(1,'transparent');
  ctx.fillStyle = grad; ctx.fillRect(0,0,W,3);
  ctx.font = 'bold 24px Georgia'; ctx.fillStyle = '#f5d06e'; ctx.textAlign = 'center';
  ctx.fillText('üìñ Tilawah Ramadhan ' + getRamLabel(), W/2, 50);
  ctx.font = '16px sans-serif'; ctx.fillStyle = '#8899bb';
  ctx.fillText(S.userName + ' ‚Ä¢ Hari ke-' + getRamadhanDay(), W/2, 78);
  const pct = S.totalTarget > 0 ? Math.min(100, Math.round((S.totalRead/S.totalTarget)*100)) : 0;
  ctx.font = 'bold 64px Georgia'; ctx.fillStyle = '#f5d06e';
  ctx.fillText(pct + '%', W/2, 160);
  ctx.font = '15px sans-serif'; ctx.fillStyle = '#8899bb';
  ctx.fillText('target tercapai', W/2, 185);
  const stats = [
    ['üìñ', S.totalRead + ' hal', 'Dibaca'],
    ['üèÜ', S.currentKhatam + '√ó Khatam', 'Tercapai'],
    ['üéØ', S.dailyTarget + ' hal/hari', 'Target Harian'],
  ];
  stats.forEach((s, i) => {
    const x = 100 + i*200 + 50;
    ctx.font = '22px sans-serif'; ctx.fillStyle = '#fff'; ctx.textAlign = 'center';
    ctx.fillText(s[0], x, 240);
    ctx.font = 'bold 18px sans-serif'; ctx.fillStyle = '#f5d06e'; ctx.fillText(s[1], x, 268);
    ctx.font = '13px sans-serif'; ctx.fillStyle = '#8899bb'; ctx.fillText(s[2], x, 287);
  });
  ctx.fillStyle = '#1a2035';
  ctx.beginPath(); ctx.roundRect(60, 310, W-120, 14, 7); ctx.fill();
  ctx.fillStyle = '#4a90e8';
  ctx.beginPath(); ctx.roundRect(60, 310, (W-120)*(pct/100), 14, 7); ctx.fill();
  ctx.font = '13px sans-serif'; ctx.fillStyle = '#4a5578'; ctx.textAlign = 'center';
  ctx.fillText(APP_LINK, W/2, 380);
  ctx.fillStyle = '#e8b84b'; ctx.fillRect(60, 395, W-120, 1);
}

function shareProgressCard() {
  if (!S.modeSet) return;
  _shareCanvasDirty = true; renderShareCanvas();
  const pct = S.totalTarget > 0 ? Math.min(100, Math.round((S.totalRead/S.totalTarget)*100)) : 0;
  const text = `üìñ *Tilawah ${getRamLabel()}* ‚Äî ${S.userName}\n\nHari ke-${getRamadhanDay()} ‚Ä¢ ${pct}% target tercapai\nüìö ${S.totalRead} halaman dibaca ‚Ä¢ üèÜ ${S.currentKhatam}√ó khatam\n\nLacak tilawahmu juga di: ${APP_LINK}`;
  const canvas = el('shareCanvas');
  canvas.toBlob(blob => {
    const file = new File([blob], 'tilawah-progres.png', {type:'image/png'});
    if (navigator.canShare?.({files:[file]})) {
      navigator.share({files:[file], text}).catch(()=>{});
    } else {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'tilawah-progres.png'; a.click();
      URL.revokeObjectURL(a.href); // v1.5: prevent memory leak
      setTimeout(() => showShareSheet('card', text), 500);
    }
  });
}
function downloadCanvas() {
  _shareCanvasDirty = true; renderShareCanvas();
  const a = document.createElement('a');
  a.href = el('shareCanvas').toDataURL('image/png');
  a.download = 'tilawah-' + localDate() + '.png'; a.click();
  showToast('üì• Kartu progres tersimpan!');
}

// ‚îÄ‚îÄ‚îÄ Share Link ‚îÄ‚îÄ‚îÄ
function copyAppLink() {
  navigator.clipboard?.writeText(APP_LINK).then(() => showToast('‚úÖ Link disalin!')).catch(() => {
    const t = document.createElement('textarea');
    t.value = APP_LINK; document.body.appendChild(t);
    t.select(); document.execCommand('copy');
    document.body.removeChild(t);
    showToast('‚úÖ Link disalin!');
  });
}
function shareAppLink() {
  const text = `üìñ *Target Tilawah Ramadhan* ‚Äî Gratis, Online, Tanpa Install!\n\nYuk lacak target khatam Al-Qur'an kamu di Ramadhan ini üåô\n\nüëâ ${APP_LINK}`;
  if (navigator.share) {
    navigator.share({ title: 'Target Tilawah Ramadhan', text, url: APP_LINK }).catch(()=>{});
  } else {
    showShareSheet('link', text);
  }
}

function showShareSheet(type, text) {
  const encoded = encodeURIComponent(text);
  const encodedLink = encodeURIComponent(APP_LINK);
  const options = [
    { icon:'üí¨', label:'WhatsApp', action: () => window.open('https://wa.me/?text='+encoded,'_blank') },
    { icon:'üìò', label:'Facebook', action: () => window.open('https://www.facebook.com/sharer/sharer.php?u='+encodedLink,'_blank') },
    { icon:'üê¶', label:'Twitter/X', action: () => window.open('https://twitter.com/intent/tweet?text='+encoded,'_blank') },
    { icon:'‚úâÔ∏è', label:'Email', action: () => window.open('mailto:?subject=Aplikasi%20Tilawah%20Ramadhan&body='+encoded,'_blank') },
    { icon:'üìã', label:'Salin Teks', action: () => copyShareText(text) },
    { icon:'üîó', label:'Salin Link', action: () => copyShareText(APP_LINK) },
    { icon:'üì§', label:'Telegram', action: () => window.open('https://t.me/share/url?url='+encodedLink+'&text='+encoded,'_blank') },
    { icon:'üì±', label:'SMS', action: () => window.open('sms:?body='+encoded,'_blank') },
  ];
  setText('shareSheetTitle', type==='card'?'Bagikan Kartu Progres':'Bagikan Aplikasi');
  // BUG-001 fix: use addEventListener instead of inline onclick strings
  el('shareOptions').innerHTML = options.map((o,i) =>
    `<div class="share-option" data-idx="${i}">
      <span class="share-option-icon">${o.icon}</span>
      <span class="share-option-label">${o.label}</span>
    </div>`
  ).join('');
  el('shareOptions').querySelectorAll('.share-option').forEach((el, i) => {
    el.addEventListener('click', () => { options[i].action(); closeShareSheet(); });
  });
  el('shareSheet').style.display = 'flex';
}
function copyShareText(text) {
  navigator.clipboard?.writeText(text).then(()=>showToast('‚úÖ Disalin!')).catch(()=>{
    const t = document.createElement('textarea');
    t.value=text; document.body.appendChild(t); t.select();
    document.execCommand('copy'); document.body.removeChild(t);
    showToast('‚úÖ Disalin!');
  });
}
function closeShareSheet() { el('shareSheet').style.display = 'none'; }
function closeShareSheetBg(e) { if (e.target===el('shareSheet')) closeShareSheet(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BACKUP & RESTORE (v1.5: relabeled)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function backupData() {
  const backup = { version:'1.5', exportedAt: new Date().toISOString(), appName:'Tilawah Ramadhan', data: S };
  const blob = new Blob([JSON.stringify(backup, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `tilawah-backup-${localDate()}.json`;
  a.click();
  setTimeout(() => {
    URL.revokeObjectURL(url); // v1.5: BUG-005 fix
    showToast('üì¶ File backup diunduh!');
    if (navigator.share) {
      const file = new File([JSON.stringify(backup,null,2)], a.download, {type:'application/json'});
      if (navigator.canShare?.({files:[file]})) {
        navigator.share({files:[file], text:`Backup data tilawah Ramadhanku ‚Äî ${localDate()}`}).catch(()=>{});
      }
    }
  }, 400);
}
function triggerRestoreData() {
  showModal('‚¨áÔ∏è Pulihkan Data',
    `<div style="font-size:0.84rem;color:var(--text2);line-height:1.8;">
      <strong style="color:var(--amber);">‚ö†Ô∏è Perhatian:</strong> Memulihkan data akan <strong>mengganti semua data saat ini</strong>.<br><br>
      Pilih file <strong style="color:var(--gold2);">.json</strong> hasil backup dari aplikasi ini.
    </div>`,
    'Pilih File Backup', () => { closeModal(); el('restoreFileInput').click(); },
    'Batal', closeModal
  );
}
function doTriggerRestore() { closeModal(); el('restoreFileInput').click(); }
function restoreData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const backup = JSON.parse(e.target.result);
      if (!backup.data || !backup.appName || backup.appName !== 'Tilawah Ramadhan') {
        showToast('‚ùå File tidak valid. Pastikan pilih file backup dari aplikasi ini.');
        return;
      }
      S = { ...S, ...backup.data };
      save(); updateAllUI();
      showToast('‚úÖ Data berhasil dipulihkan!');
      showModal('‚úÖ Pemulihan Berhasil!',
        `<div style="font-size:0.86rem;color:var(--text2);line-height:1.8;">
          Data tilawah <strong style="color:var(--gold2);">${S.userName}</strong> berhasil dipulihkan.<br>
          Total: <strong style="color:var(--green);">${S.totalRead} halaman</strong> dari ${Object.keys(S.dailyLogs||{}).length} hari.
        </div>`,
        'Lanjutkan', closeModal, null, null
      );
    } catch(err) { showToast('‚ùå File rusak atau format tidak dikenal.'); }
    event.target.value = '';
  };
  reader.readAsText(file);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BACKFILL BANNER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkBackfillBanner() {
  if (!S.modeSet || _backfillDismissed) return;
  if (localStorage.getItem('tilawah_backfillDismissed') === '1') {
    _backfillDismissed = true; return;
  }
  const banner = el('backfillBanner');
  if (!banner) return;
  const daysGone = getDaysGone();
  const loggedDays = Object.keys(S.dailyLogs || {}).length;
  if (daysGone >= 2 && loggedDays < Math.ceil(daysGone * 0.5)) {
    const missingDays = daysGone - loggedDays;
    const textEl = el('backfillText');
    if (textEl) textEl.textContent = `Ramadhan sudah berjalan ${daysGone} hari, tapi baru ada ${loggedDays} hari data. Kamu bisa mengisi catatan untuk ${missingDays} hari yang belum tercatat.`;
    banner.style.display = 'flex';
  } else {
    banner.style.display = 'none';
  }
}
function openBackfillGuide() {
  showModal('üìù Cara Isi Data Hari Sebelumnya',
    `<div style="font-size:0.84rem;color:var(--text2);line-height:2;">
      <strong style="color:var(--gold2);">Langkah mudah:</strong><br>
      1Ô∏è‚É£ Di bawah, ubah tanggal ke hari yang ingin diisi<br>
      2Ô∏è‚É£ Pilih waktu sholat dan masukkan jumlah halaman<br>
      3Ô∏è‚É£ Klik <strong>Tambah Tilawah</strong><br>
      4Ô∏è‚É£ Ulangi untuk setiap sesi baca di hari itu<br><br>
      <div style="background:var(--surface2);border-radius:8px;padding:10px 12px;font-size:0.8rem;color:var(--text3);">
        üí° Tidak ingat jumlah pasti? Masukkan <em>perkiraan</em> saja ‚Äî yang penting konsisten mencatat mulai hari ini.
      </div>
    </div>`,
    'Ke Tab Catat', () => { showSection('input'); closeModal(); },
    'Nanti Dulu', closeModal
  );
}
function dismissBackfill() {
  _backfillDismissed = true;
  localStorage.setItem('tilawah_backfillDismissed', '1');
  const banner = el('backfillBanner');
  if (banner) banner.style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REMINDERS (v1.5: with status display)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateNotifStatusBar() {
  const dot = el('reminderStatusDot');
  const text = el('reminderStatusText');
  const btn = el('notifPermBtn');
  const tip = el('reminderPwaTip');
  if (!dot || !text) return;

  const perm = typeof Notification !== 'undefined' ? Notification.permission : 'unsupported';
  dot.className = 'reminder-status-dot ' + (perm === 'granted' ? 'granted' : perm === 'denied' ? 'denied' : 'default');

  const isPWA = window.matchMedia?.('(display-mode: standalone)').matches || window.navigator.standalone;

  if (perm === 'unsupported') {
    text.textContent = 'Notifikasi tidak didukung di browser ini';
    if (btn) btn.style.display = 'none';
    if (tip) tip.style.display = '';
  } else if (perm === 'granted') {
    text.textContent = '‚úÖ Izin notifikasi diberikan';
    if (btn) btn.style.display = 'none';
    if (tip) tip.style.display = 'none';
  } else if (perm === 'denied') {
    text.textContent = '‚ùå Notifikasi diblokir ‚Äî buka Pengaturan browser';
    if (btn) btn.style.display = 'none';
    if (tip) tip.style.display = '';
  } else {
    text.textContent = 'Izin notifikasi belum diberikan';
    if (btn) btn.style.display = '';
    if (tip) tip.style.display = isPWA ? 'none' : '';
  }
}
function requestNotifPermission() {
  if (typeof Notification === 'undefined') { showToast('‚ö†Ô∏è Browser ini tidak mendukung notifikasi'); return; }
  Notification.requestPermission().then(perm => {
    updateNotifStatusBar();
    if (perm === 'granted') showToast('‚úÖ Izin notifikasi diberikan!');
    else if (perm === 'denied') showToast('‚ùå Notifikasi diblokir');
  });
}
function initReminders() {
  if (!S.reminders.length) {
    S.reminders = [
      {id:1, hour:5, minute:0, label:'Subuh ‚Äî Tilawah pagi', active:false},
      {id:2, hour:13, minute:0, label:'Dzuhur ‚Äî Jeda tilawah', active:false},
      {id:3, hour:20, minute:30, label:'Tarawih ‚Äî Tilawah malam', active:false},
    ];
    save();
  }
  renderReminders();
}
function renderReminders() {
  const container = el('reminderList');
  if (!container) return;
  if (!S.reminders?.length) {
    container.innerHTML = '<div class="empty-state" style="padding:16px;"><span class="empty-icon">üîî</span>Belum ada pengingat.</div>';
    return;
  }
  container.innerHTML = S.reminders.map(r => `
    <div class="reminder-item ${r.active?'active':''}">
      <span class="reminder-time">${String(r.hour).padStart(2,'0')}:${String(r.minute).padStart(2,'0')}</span>
      <span class="reminder-label">${r.label}</span>
      <label class="toggle-wrap">
        <input type="checkbox" ${r.active?'checked':''} onchange="toggleReminder(${r.id})">
        <span class="toggle-slider"></span>
      </label>
      <button class="reminder-del-btn" onclick="confirmDeleteReminder(${r.id})" title="Hapus pengingat" aria-label="Hapus pengingat">üóëÔ∏è</button>
    </div>`).join('');
}
function toggleReminder(id) {
  const r = S.reminders.find(r=>r.id===id);
  if (!r) return;
  r.active = !r.active;
  if (r.active && typeof Notification !== 'undefined' && Notification.permission === 'default') {
    requestNotifPermission();
  }
  if (r.active && typeof Notification !== 'undefined' && Notification.permission === 'granted') {
    showToast(`üîî Pengingat "${r.label}" aktif`);
  } else if (r.active && typeof Notification !== 'undefined' && Notification.permission !== 'granted') {
    showToast('‚ö†Ô∏è Izinkan notifikasi dulu agar pengingat berfungsi');
    r.active = false;
  }
  save(); renderReminders(); updateNotifStatusBar();
}
function confirmDeleteReminder(id) {
  showModal('üóë Hapus Pengingat?', 'Pengingat ini akan dihapus.',
    'Ya, Hapus', () => { deleteReminder(id); },
    'Batal', closeModal
  );
}
function deleteReminder(id) {
  S.reminders = S.reminders.filter(r=>r.id!==id);
  save(); closeModal(); renderReminders();
  showToast('üóëÔ∏è Pengingat dihapus');
}
function addReminder() {
  showModal('+ Tambah Pengingat',
    `<div class="form-group"><label>Waktu</label><input id="newReminderTime" type="time" value="07:00"></div>
     <div class="form-group"><label>Keterangan</label><input id="newReminderLabel" type="text" value="Tilawah" maxlength="40"></div>`,
    'Tambah', () => {
      const time = el('newReminderTime')?.value || '07:00';
      const label = el('newReminderLabel')?.value.trim() || 'Tilawah';
      const [h, m] = time.split(':').map(Number);
      S.reminders.push({ id: Date.now(), hour:h, minute:m, label, active:false });
      save(); closeModal(); renderReminders();
      showToast('‚úÖ Pengingat ditambahkan');
    },
    'Batal', closeModal
  );
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT CSV (BUG-004: proper escaping)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportCSV(mode) {
  if (!S.modeSet) { showToast('‚ö†Ô∏è Setup dulu sebelum export'); return; }
  const allLogs = Object.values(S.dailyLogs).flat();
  if (!allLogs.length) { showToast('‚ö†Ô∏è Belum ada data untuk di-export'); return; }

  const BOM = '\uFEFF';
  let csv, filename;

  if (mode === 'detail') {
    const header = ['Tanggal','Hari Ramadhan','Waktu Sholat','Halaman','Posisi Baca','Waktu Catat'];
    const rows = [];
    Object.keys(S.dailyLogs).sort().forEach(ds => {
      const ramDay = Math.round((new Date(ds+'T00:00:00') - new Date(S.startDate+'T00:00:00')) / 86400000) + 1;
      (S.dailyLogs[ds]||[]).forEach(l => {
        // BUG-004 fix: escape ALL fields
        rows.push([
          csvEscape(ds), csvEscape(ramDay), csvEscape(l.prayer),
          csvEscape(l.pages), csvEscape(l.pos||''), csvEscape(l.time||'')
        ].join(','));
      });
    });
    csv = BOM + header.map(csvEscape).join(',') + '\n' + rows.join('\n');
    filename = `tilawah-detail-${localDate()}.csv`;
    showToast(`üìä Export ${rows.length} baris berhasil!`);
  } else {
    const header = ['Tanggal','Hari Ramadhan','Total Halaman','Total Juz','Target Harian','Status','Jumlah Sesi'];
    const rows = [];
    for (let i = 0; i < DAYS_RAMADHAN; i++) {
      const dt = new Date(S.startDate+'T00:00:00');
      dt.setDate(dt.getDate() + i);
      const ds = dt.toLocaleDateString('en-CA');
      const pages = getTodayPages(ds);
      const juz = (pages / (PAGES_PER_KHATAM / 30)).toFixed(2);
      const sesi = (S.dailyLogs[ds]||[]).length;
      const status = pages===0?'Kosong':pages>=S.dailyTarget?'Tercapai':pages>=S.dailyTarget*0.8?'Hampir':'Di bawah';
      rows.push([ds, i+1, pages, juz, S.dailyTarget, status, sesi].map(csvEscape).join(','));
    }
    csv = BOM + header.map(csvEscape).join(',') + '\n' + rows.join('\n');
    filename = `tilawah-harian-${localDate()}.csv`;
    showToast(`üìÖ Export 30 hari berhasil!`);
  }

  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url); // v1.5: prevent memory leak
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BREAKDOWN MANUAL EDIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showEditBreakdown() {
  const current = S.customBreakdown || S.breakdown;
  const isManual = !!S.customBreakdown;
  const gridHTML = `
    <p style="font-size:0.82rem;color:var(--text2);margin-bottom:12px;line-height:1.6;">
      Atur target halaman per waktu sholat. Total sebaiknya tepat
      <strong style="color:var(--gold2);">${S.dailyTarget} halaman/hari</strong>.
    </p>
    <div class="bk-grid">
      ${PRAYERS.map(p => `
        <div class="bk-item">
          <span class="bk-emoji">${p.emoji}</span>
          <span class="bk-name">${p.name}</span>
          <input type="number" id="bk_${p.name}" value="${current[p.name]||0}" min="0" max="${S.dailyTarget}" inputmode="numeric" oninput="updateBkTotal()">
        </div>`).join('')}
    </div>
    <div class="bk-total-row">
      <span class="bk-total-lbl">Total:</span>
      <span class="bk-total-num" id="bkTotalNum">‚Äî / ${S.dailyTarget} hal</span>
    </div>
    ${isManual ? '<p class="bk-note" style="color:var(--amber);">‚öôÔ∏è Target saat ini sudah diubah manual.</p>' : ''}
  `;
  showModal('‚è∞ Ubah Target per Sholat', gridHTML,
    'üíæ Simpan', applyCustomBreakdown,
    isManual ? 'üîÑ Reset Otomatis' : 'Batal',
    isManual ? resetBreakdownToAuto : closeModal
  );
  setTimeout(updateBkTotal, 50);
}
function updateBkTotal() {
  let total = 0;
  PRAYERS.forEach(p => { total += parseInt(el('bk_'+p.name)?.value)||0; });
  const numEl = el('bkTotalNum');
  if (!numEl) return;
  numEl.textContent = `${total} / ${S.dailyTarget} hal`;
  numEl.className = 'bk-total-num' + (total===S.dailyTarget?' ok':Math.abs(total-S.dailyTarget)<=2?'':' warn');
}
function applyCustomBreakdown() {
  const bd = {};
  let total = 0;
  PRAYERS.forEach(p => {
    const v = Math.max(0, parseInt(el('bk_'+p.name)?.value)||0);
    bd[p.name] = v; total += v;
  });
  if (Math.abs(total - S.dailyTarget) > 3) {
    showToast(`‚ö†Ô∏è Total (${total}) harus mendekati ${S.dailyTarget} halaman`);
    return;
  }
  const diff = S.dailyTarget - total;
  if (diff !== 0) bd['Tarawih'] = Math.max(0, (bd['Tarawih']||0) + diff);
  S.customBreakdown = bd;
  S.breakdown = bd;
  save(); closeModal(); renderPrayerBreakdown();
  showToast('‚úÖ Target per sholat disimpan!');
}
function resetBreakdownToAuto() {
  S.customBreakdown = null;
  S.breakdown = calcBreakdown(S.dailyTarget);
  save(); closeModal(); renderPrayerBreakdown();
  showToast('üîÑ Target kembali ke otomatis');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSettings() {
  if (!S.modeSet) return;
  setText('settingNameDisplay', S.userName);
  setText('settingKhatamDisplay', `${S.khatamTarget}√ó khatam (${S.totalTarget} halaman)`);
  setText('settingStartDisplay', S.startDate);
  const totalLogs = Object.values(S.dailyLogs).flat().length;
  setText('statTotalLogs', totalLogs);
  setHTML('statCalcSaved', `Kalkulasi otomatis: <strong>${totalLogs * 5}+</strong>`);
  const prayerTotals = {};
  Object.values(S.dailyLogs).flat().forEach(l => { prayerTotals[l.prayer] = (prayerTotals[l.prayer]||0) + l.pages; });
  const bp = Object.entries(prayerTotals).sort((a,b)=>b[1]-a[1])[0];
  setText('statBestPrayer', bp ? `${bp[0]} (${bp[1]} hal)` : '‚Äî');
  const dayTotals = {};
  Object.entries(S.dailyLogs).forEach(([d,logs]) => {
    const day = new Date(d+'T00:00:00').toLocaleDateString('id-ID',{weekday:'long'});
    dayTotals[day] = (dayTotals[day]||0) + logs.reduce((s,l)=>s+l.pages,0);
  });
  const bd = Object.entries(dayTotals).sort((a,b)=>b[1]-a[1])[0];
  setText('statBestDay', bd ? bd[0] : '‚Äî');
  calcCatchUp();
  updateNotifStatusBar();
}
function calcCatchUp() {
  if (!S.modeSet) return;
  const daysEl = el('calcDays');
  const resultEl = el('calcResult');
  if (!daysEl || !resultEl) return;
  const days = parseInt(daysEl.value) || 0;
  if (days < 1) { resultEl.style.display = 'none'; return; }
  const rem = Math.max(0, S.totalTarget - S.totalRead);
  const needed = Math.ceil(rem / days);
  setText('calcNum', needed);
  setText('calcLabel', `halaman/hari untuk ${days} hari ke depan`);
  const advice = el('calcAdvice');
  if (advice) {
    if (needed <= S.dailyTarget) advice.innerHTML = `<span style="color:var(--green);">‚úÖ Lebih rendah dari target harianmu (${S.dailyTarget} hal). Sangat bisa dicapai!</span>`;
    else if (needed <= S.dailyTarget*1.5) advice.innerHTML = `<span style="color:var(--amber);">‚ö° Sedikit lebih dari target harian. Tambah bacaan setelah Tarawih!</span>`;
    else advice.innerHTML = `<span style="color:var(--red);">üí™ Cukup berat, tapi tidak mustahil. Manfaatkan semua waktu sholat secara konsisten.</span>`;
  }
  resultEl.style.display = '';
}
function showEditSetup() {
  const bodyHTML = `
    <div class="form-group"><label>Nama <span style="color:var(--red);">*</span></label><input id="editName" type="text" value="${S.userName}" maxlength="30"></div>
    <div class="form-group"><label>Target Khatam</label><input id="editKhatam" type="number" value="${S.khatamTarget}" min="1" max="10"></div>
    <div class="form-group"><label>Mulai Ramadhan</label><input id="editStart" type="date" value="${S.startDate}"></div>
  `;
  showModal('‚úèÔ∏è Ubah Pengaturan', bodyHTML, 'Simpan', applyEditSetup, 'Batal', closeModal);
}
function applyEditSetup() {
  const name = el('editName')?.value.trim();
  const khatam = parseInt(el('editKhatam')?.value) || 1;
  const start = el('editStart')?.value;
  if (!name) { showToast('‚ö†Ô∏è Masukkan nama!'); return; }
  S.userName = name;
  S.khatamTarget = khatam;
  S.startDate = start;
  S.totalTarget = khatam * PAGES_PER_KHATAM;
  S.dailyTarget = Math.ceil(S.totalTarget / DAYS_RAMADHAN);
  S.customBreakdown = null; // BUG: reset on target change
  S.breakdown = calcBreakdown(S.dailyTarget);
  _shareCanvasDirty = true;
  save(); closeModal(); updateAllUI(); renderSettings();
  showToast('‚úÖ Pengaturan disimpan!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL (BUG-001 fix: callbacks not strings)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showModal(title, body, btn1, fn1, btn2, fn2) {
  setText('modalTitle', title);
  setHTML('modalBody', body);
  const actions = el('modalActions');
  actions.innerHTML = '';
  if (btn1) {
    const b = document.createElement('button');
    b.className = 'btn btn-primary';
    b.textContent = btn1;
    if (typeof fn1 === 'function') b.onclick = fn1;
    actions.appendChild(b);
  }
  if (btn2) {
    const b = document.createElement('button');
    b.className = 'btn btn-secondary';
    b.textContent = btn2;
    if (typeof fn2 === 'function') b.onclick = fn2;
    actions.appendChild(b);
  }
  el('modalBackdrop').classList.remove('hidden');
}
function closeModal() { el('modalBackdrop').classList.add('hidden'); }
function closeModalBg(e) { if (e.target === el('modalBackdrop')) closeModal(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastTimer;
function showToast(msg, duration=2500) {
  const t = el('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), duration);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHECK ANIMATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showCheckAnim() {
  const e = document.createElement('div');
  e.className = 'confirm-check'; e.textContent = '‚úÖ';
  document.body.appendChild(e);
  setTimeout(() => e.remove(), 1000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RESET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function confirmResetProgress() {
  showModal('üîÑ Reset Data Bacaan?',
    'Ini akan menghapus semua log tilawah, tetapi mempertahankan pengaturan target kamu.',
    'Ya, Reset', doResetProgress, 'Batal', closeModal
  );
}
function doResetProgress() {
  if (S.totalRead > 0) {
    S.yearHistory = S.yearHistory || [];
    S.yearHistory = S.yearHistory.filter(y => y.year !== getRamLabel());
    S.yearHistory.unshift({year: getRamLabel(), khatam: S.currentKhatam, read: S.totalRead, target: S.khatamTarget});
  }
  S.dailyLogs = {}; S.totalRead = 0; S.currentKhatam = 0; S.earnedBadges = [];
  save(); closeModal(); updateAllUI();
  showToast('‚úÖ Data bacaan direset');
}
function confirmResetAll() {
  showModal('‚ö†Ô∏è Reset Semua?',
    'Ini akan menghapus SEMUA data termasuk pengaturan. Kamu harus setup ulang dari awal.',
    'Ya, Hapus Semua', doResetAll, 'Batal', closeModal
  );
}
function doResetAll() { localStorage.removeItem('tilawahV3'); location.reload(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INSTALL PWA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault(); deferredInstall = e;
  const btn = el('installBtn');
  if (btn) btn.style.display = '';
});
function triggerInstall() {
  if (deferredInstall) {
    deferredInstall.prompt();
    deferredInstall.userChoice.then(r => {
      if (r.outcome==='accepted') showToast('‚úÖ Aplikasi terpasang!');
      deferredInstall = null;
    });
  } else {
    showModal('üì≤ Cara Pasang di HP',
      `<div style="line-height:2;font-size:0.86rem;">
        <strong style="color:var(--gold2);">Android Chrome:</strong> Menu ‚ãÆ ‚Üí Tambahkan ke layar utama<br>
        <strong style="color:var(--gold2);">iPhone Safari:</strong> Tombol Bagikan ‚¨Ü ‚Üí Tambahkan ke Layar Utama<br>
        <strong style="color:var(--gold2);">Samsung Internet:</strong> Menu ‚â° ‚Üí Tambahkan halaman ke ‚Üí Layar beranda
      </div>`,
      'Mengerti', closeModal, null, null
    );
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTOCOMPLETE SURAH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SURAH_LIST = [
  {n:'Al-Fatihah',j:1},{n:'Al-Baqarah',j:1},{n:'Ali Imran',j:3},{n:'An-Nisa',j:4},
  {n:'Al-Maidah',j:6},{n:'Al-Anam',j:7},{n:'Al-Araf',j:8},{n:'Al-Anfal',j:9},
  {n:'At-Taubah',j:10},{n:'Yunus',j:11},{n:'Hud',j:11},{n:'Yusuf',j:12},
  {n:'Ar-Rad',j:13},{n:'Ibrahim',j:13},{n:'Al-Hijr',j:14},{n:'An-Nahl',j:14},
  {n:'Al-Isra',j:15},{n:'Al-Kahfi',j:15},{n:'Maryam',j:16},{n:'Ta-Ha',j:16},
  {n:'Al-Anbiya',j:17},{n:'Al-Hajj',j:17},{n:'Al-Muminun',j:18},{n:'An-Nur',j:18},
  {n:'Al-Furqan',j:18},{n:'Asy-Syuara',j:19},{n:'An-Naml',j:19},{n:'Al-Qasas',j:20},
  {n:'Al-Ankabut',j:20},{n:'Ar-Rum',j:21},{n:'Luqman',j:21},{n:'As-Sajdah',j:21},
  {n:'Al-Ahzab',j:21},{n:'Saba',j:22},{n:'Fatir',j:22},{n:'Yasin',j:22},
  {n:'As-Saffat',j:23},{n:'Sad',j:23},{n:'Az-Zumar',j:23},{n:'Ghafir',j:24},
  {n:'Fussilat',j:24},{n:'Asy-Syura',j:25},{n:'Az-Zukhruf',j:25},{n:'Ad-Dukhan',j:25},
  {n:'Al-Jasiyah',j:25},{n:'Al-Ahqaf',j:26},{n:'Muhammad',j:26},{n:'Al-Fath',j:26},
  {n:'Al-Hujurat',j:26},{n:'Qaf',j:26},{n:'Az-Zariyat',j:26},{n:'At-Tur',j:27},
  {n:'An-Najm',j:27},{n:'Al-Qamar',j:27},{n:'Ar-Rahman',j:27},{n:'Al-Waqiah',j:27},
  {n:'Al-Hadid',j:27},{n:'Al-Mujadilah',j:28},{n:'Al-Hasyr',j:28},{n:'Al-Mumtahanah',j:28},
  {n:'As-Saff',j:28},{n:'Al-Jumuah',j:28},{n:'Al-Munafiqun',j:28},{n:'At-Tagabun',j:28},
  {n:'At-Talaq',j:28},{n:'At-Tahrim',j:28},{n:'Al-Mulk',j:29},{n:'Al-Qalam',j:29},
  {n:'Al-Haqqah',j:29},{n:'Al-Maarij',j:29},{n:'Nuh',j:29},{n:'Al-Jin',j:29},
  {n:'Al-Muzzammil',j:29},{n:'Al-Muddassir',j:29},{n:'Al-Qiyamah',j:29},{n:'Al-Insan',j:29},
  {n:'Al-Mursalat',j:29},{n:'An-Naba',j:30},{n:'An-Naziat',j:30},{n:'Abasa',j:30},
  {n:'At-Takwir',j:30},{n:'Al-Infitar',j:30},{n:'Al-Mutaffifin',j:30},{n:'Al-Insyiqaq',j:30},
  {n:'Al-Buruj',j:30},{n:'At-Tariq',j:30},{n:'Al-Ala',j:30},{n:'Al-Gasyiyah',j:30},
  {n:'Al-Fajr',j:30},{n:'Al-Balad',j:30},{n:'Asy-Syams',j:30},{n:'Al-Lail',j:30},
  {n:'Ad-Duha',j:30},{n:'Asy-Syarh',j:30},{n:'At-Tin',j:30},{n:'Al-Alaq',j:30},
  {n:'Al-Qadr',j:30},{n:'Al-Bayyinah',j:30},{n:'Az-Zalzalah',j:30},{n:'Al-Adiyat',j:30},
  {n:'Al-Qariah',j:30},{n:'At-Takasur',j:30},{n:'Al-Asr',j:30},{n:'Al-Humazah',j:30},
  {n:'Al-Fil',j:30},{n:'Quraisy',j:30},{n:'Al-Maun',j:30},{n:'Al-Kausar',j:30},
  {n:'Al-Kafirun',j:30},{n:'An-Nasr',j:30},{n:'Al-Masad',j:30},{n:'Al-Ikhlas',j:30},
  {n:'Al-Falaq',j:30},{n:'An-Nas',j:30}
];

let _acFocusIdx = -1;

function onPosInput(input) {
  const val = input.value.trim();
  const dropId = input.id === 'lastPosInput' ? 'posDropdown' : 'posDropdownSheet';
  const drop = el(dropId);
  if (!drop) return;
  if (val.length < 2) { drop.classList.remove('open'); return; }
  const q = val.toLowerCase().replace(/[^a-z0-9]/g,'');
  const results = SURAH_LIST.filter(s => s.n.toLowerCase().replace(/[^a-z]/g,'').includes(q)).slice(0, 6);
  if (!results.length) { drop.classList.remove('open'); return; }
  _acFocusIdx = -1;
  // BUG-001 fix: use data attribute + event delegation instead of inline onmousedown
  drop.innerHTML = results.map((s, i) =>
    `<div class="ac-item" data-name="${s.n}" data-input-id="${input.id}" data-idx="${i}">
       <span class="ac-surah">${s.n}</span>
       <span class="ac-juz">Juz ${s.j}</span>
     </div>`
  ).join('');
  drop.querySelectorAll('.ac-item').forEach(item => {
    item.addEventListener('mousedown', (e) => {
      e.preventDefault();
      selectSurah(input.id, item.dataset.name, dropId);
    });
  });
  drop.classList.add('open');
}
function onPosKey(e) {
  const input = e.target;
  const dropId = input.id === 'lastPosInput' ? 'posDropdown' : 'posDropdownSheet';
  const drop = el(dropId);
  if (!drop || !drop.classList.contains('open')) return;
  const items = drop.querySelectorAll('.ac-item');
  if (!items.length) return;
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    _acFocusIdx = Math.min(_acFocusIdx + 1, items.length - 1);
    items.forEach((it, i) => it.classList.toggle('focused', i === _acFocusIdx));
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    _acFocusIdx = Math.max(_acFocusIdx - 1, -1);
    items.forEach((it, i) => it.classList.toggle('focused', i === _acFocusIdx));
  } else if (e.key === 'Enter' && _acFocusIdx >= 0) {
    e.preventDefault();
    selectSurah(input.id, items[_acFocusIdx].dataset.name, dropId);
  } else if (e.key === 'Escape') {
    drop.classList.remove('open');
  }
}
function selectSurah(inputId, name, dropId) {
  const inp = el(inputId);
  if (inp) inp.value = name;
  const drop = el(dropId || (inputId === 'lastPosInput' ? 'posDropdown' : 'posDropdownSheet'));
  if (drop) drop.classList.remove('open');
}
function hidePosDropdown() {
  setTimeout(() => {
    ['posDropdown','posDropdownSheet'].forEach(id => { el(id)?.classList.remove('open'); });
  }, 150);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function init() {
  load();
  if (S.modeSet) {
    el('welcomeScreen').style.display = 'none';
    launchMainApp();
  }
  updateHeader();
}

init();
</script>
</body>
</html>
